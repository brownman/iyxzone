Iyxzone.Photo={version:'1.0',author:['高侠鸿'],Tagger:Class.create({}),SlideManager:{},Slide:Class.create({}),Slide2:Class.create({})};Iyxzone.Photo.FriendSelector=Class.create({initialize:function(toggleButton,input,friendList,friendTable,friendItems,gameSelector,token){this.friendID=0;this.toggleButton=$(toggleButton);this.friendList=$(friendList);this.friendTable=$(friendTable);this.friendItems=$(friendItems);this.gameSelector=$(gameSelector);this.token=token;Event.observe(this.toggleButton,'click',function(e){this.toggleFriends();}.bind(this));Event.observe(this.gameSelector,'change',function(){this.getFriends();}.bind(this));this.textboxList=new TextBoxList(input,{onBoxDispose:this.removeBox.bind(this),holderClassName:'friend-select-list s_clear',bitClassName:''});var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;inputs[i].observe('click',this.afterCheckFriend.bindAsEventListener(this));}}
var pinyins=[];var names=[];var ids=[];this.friendItems.childElements().each(function(li){pinyins.push(li.down('input').readAttribute('pinyin'));names.push(li.down('input').readAttribute('login'));ids.push(li.down('input').value);}.bind(this));new Iyxzone.Friend.Autocompleter(this.textboxList.getMainInput(),this.friendList,{ids:ids,names:names,pinyins:pinyins,emptyText:'没有匹配的好友...',tipText:'输入你好友的姓名或者拼音',afterUpdateElement:this.afterSelectFriend.bind(this),comp:this.textboxList.holder});},removeBox:function(el,input){var friendID=input.value;this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}},add:function(info){if(this.textboxList.bits.size()!=0){this.textboxList.disposeAll();}
this.textboxList.add(info.id,info.login);this.friendID=info.id;},getFriends:function(){var gameID=this.gameSelector.value;var friends=this.friendItems.childElements();friends.each(function(f){var info=f.readAttribute('info').evalJSON();var games=info.games;if(gameID=='all'||games.include(gameID)){f.show();}else{f.hide();}}.bind(this));},toggleFriends:function(){if(!this.friendTable.visible()){var pos=this.toggleButton.positionedOffset();this.friendTable.setStyle({position:'absolute',left:(pos.left+this.toggleButton.getWidth()-this.friendTable.getWidth())+'px',top:(pos.top+this.toggleButton.getHeight())+'px'});this.friendTable.show();}else{this.friendTable.hide();}},afterSelectFriend:function(input,selectedLI){var id=selectedLI.readAttribute('id');var login=selectedLI.childElements()[0].innerHTML;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;if(inputs[i].value==id)
inputs[i].checked=true;}}
this.add({id:id,login:login});input.clear();},afterCheckFriend:function(mouseEvent){var checkbox=mouseEvent.target;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i]!=checkbox){inputs[i].checked=false;}}
this.toggleFriends();this.add({id:checkbox.value,login:checkbox.readAttribute('login')});},reset:function(){this.textboxList.getMainInput().clear();this.textboxList.disposeAll();this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}}});Iyxzone.Photo.Tagger=Class.create({initialize:function(type,photoID,controlPanel,confirmButton,cancelButton,tagInfos,tagsHolder,isCurrentUser,contentInput,toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token,options){this.options=Object.extend({ratio:0.2},options||{});this.type=type;this.photoID=photoID;this.photo=$('photo_'+this.photoID);this.controlPanel=$(controlPanel);this.contentInput=$(contentInput);this.confirmButton=$(confirmButton);this.cancelButton=$(cancelButton);this.tagInfos=new Hash();this.tagsHolder=$(tagsHolder);this.isCurrentUser=isCurrentUser;this.token=token;this.started=false;this.isLoading=true;if(tagInfos.length!=0)
this.tagsHolder.innerHTML='<img src="/images/loading.gif" />';for(var i=0;i<tagInfos.length;i++){this.insertTag(tagInfos[i]);}
this.friendSelector=new Iyxzone.Photo.FriendSelector(toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token);Event.observe(this.confirmButton,'click',function(e){Event.stop(e);this.save();}.bind(this));Event.observe(this.cancelButton,'click',function(e){Event.stop(e);this.reset();this.started=false;}.bind(this));this.mousemoveBind=this.showNearestTagWithContent.bindAsEventListener(this);Event.observe(this.photo,'mousemove',this.mousemoveBind);},insertTag:function(tagInfo){this.tagInfos.set(tagInfo.photo_tag.id,{id:tagInfo.photo_tag.id,width:tagInfo.photo_tag.width,height:tagInfo.photo_tag.height,left:tagInfo.photo_tag.x,top:tagInfo.photo_tag.y,content:tagInfo.photo_tag.content,tagged_user_id:tagInfo.photo_tag.tagged_user.id,tagged_user_login:tagInfo.photo_tag.tagged_user.login,poster_id:tagInfo.photo_tag.poster.id,poster_login:tagInfo.photo_tag.poster.login});var li=new Element('li',{id:'tag_'+tagInfo.photo_tag.id});var rectTag=new Element('strong');var posterLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.poster.id}).update(tagInfo.photo_tag.poster.login);var taggedUserLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.tagged_user.id}).update(tagInfo.photo_tag.tagged_user.login);rectTag.appendChild(posterLink);rectTag.innerHTML+=('标记了');rectTag.appendChild(taggedUserLink);rectTag.innerHTML+=(' : '+tagInfo.photo_tag.content.escapeHTML());li.appendChild(rectTag);if(this.isLoading){this.tagsHolder.innerHTML='';Element.insert(this.tagsHolder,{bottom:li});this.isLoading=false;}else{Element.insert(this.tagsHolder,{bottom:li});}
Event.observe('tag_'+tagInfo.photo_tag.id,'mouseover',function(e){this.showTagWithContent(tagInfo.photo_tag.id);}.bind(this));Event.observe('tag_'+tagInfo.photo_tag.id,'mouseout',function(e){this.hideTagWithContent(tagInfo.photo_tag.id);}.bind(this));if(this.isCurrentUser){var deleteLink=new Element('a',{href:'javascript: void(0)','class':'icon-active'});var spaceBar=new Element('span');li.appendChild(deleteLink);li.appendChild(spaceBar);deleteLink.observe('click',function(e){facebox.show_confirm_with_callbacks('你确定要删除这个标价吗?',this.remove.bind(this),tagInfo.photo_tag.id);}.bind(this));}},start:function(){if(this.started){return;}
var min=0;if(this.photo.getWidth()<this.photo.getHeight()){min=this.photo.getWidth()*this.options.ratio;}else{min=this.photo.getHeight()*this.options.ratio;}
this.cropImg=new Cropper.Img('photo_'+this.photoID,{onDragging:this.onDragging.bind(this),minWidth:min,minHeight:min,displayOnInit:true,onloadCoords:{x1:this.photo.getWidth()-min,y1:0,x2:this.photo.getWidth(),y2:min}});this.onDragging({x1:this.photo.getWidth()-min,y1:0},{width:min,height:min});Event.stopObserving(this.photo,'mousemove',this.mousemoveBind);this.started=true;},onDragging:function(coords,dimensions){var pos=Element.cumulativeOffset(this.photo);this.controlPanel.setStyle({position:'absolute',left:(pos.left+coords.x1+dimensions.width+2)+'px',top:(pos.top+coords.y1)+'px',zIndex:200});this.controlPanel.show();},validate:function(){if(this.friendSelector.friendID==0){error('你需要选择一个好友');return false;}
return true;},remove:function(tagID){new Ajax.Request('/photo_tags/'+tagID,{method:'delete',parameters:'authenticity_token='+encodeURIComponent(this.token),loading:function(){Iyxzone.changeCursor('wait');},onSuccess:function(transport){if($('square_'+tagID))$('square_'+tagID).remove();if($('content_'+tagID))$('content_'+tagID).remove();$('tag_'+tagID).remove();this.tagInfos.unset(tagID);Iyxzone.changeCursor('default');}.bind(this)});},save:function(){Iyxzone.disableButton(this.confirmButton,'保存中');if(this.validate()){var params="";params=$('tag_form').serialize();params+="&tag[tagged_user_id]="+this.friendSelector.friendID;params+="&tag[x]="+this.cropImg.areaCoords.x1;params+="&tag[y]="+this.cropImg.areaCoords.y1;params+="&tag[width]="+this.cropImg.calcW();params+="&tag[height]="+this.cropImg.calcH();params+="&tag[photo_id]="+this.photoID;params+="&tag[photo_type]="+this.type;new Ajax.Request('/photo_tags',{method:'post',parameters:params,onSuccess:function(transport){this.friendSelector.reset();this.contentInput.clear();var tagInfo=transport.responseText.evalJSON();this.insertTag(tagInfo);Iyxzone.enableButton(this.confirmButton,'保存');}.bind(this)});}else{Iyxzone.enableButotn(this.confirmButotn,'保存');}},showNearestTagWithContent:function(event){var distance=100000000;var tagID=-1;var photoX=this.photo.positionedOffset().left;var photoY=this.photo.positionedOffset().top;var mouseX=event.pointerX();var mouseY=event.pointerY();this.tagInfos.each(function(pair){var x=photoX+pair.value.left;var width=pair.value.width;var y=photoY+pair.value.top;var height=pair.value.height;if(mouseX>=x&&mouseX<=x+width&&mouseY>=y&&mouseY<=y+height){var deltaX=(x+width/2)-mouseX;var deltaY=(y+height/2)-mouseY;var delta=((x+width/2)-mouseX)*((x+width/2)-mouseX)+((y+height/2)-mouseY)*((y+height/2)-mouseY);if(delta<distance){distance=delta;tagID=pair.key;}}else{if(pair.key==this.currentTagID){this.hideTagWithContent(this.currentTagID);this.currentTagID=-1;}}}.bind(this));if(tagID>=0){this.currentTagID=tagID;this.showTagWithContent(tagID);}},hideTagWithContent:function(tagID){var square=$('square_'+tagID);var info=$('content_'+tagID);if(square)square.hide();if(info)info.hide();},showTagWithContent:function(tagID){var tag=this.tagInfos.get(tagID);var pos=this.photo.positionedOffset();var x=tag.left;var y=tag.top;var width=tag.width;var height=tag.height;var square=$('square_'+tagID);if(!square){square=new Element('div',{className:'square-class',id:'square_'+tagID});document.body.appendChild(square);}
square.setStyle({'position':'absolute','width':width+'px','height':height+'px','left':(x+pos.left)+'px','top':(y+pos.top)+'px','border':'2px solid #eeeeee','display':'block','zIndex':4});var info=$('content_'+tagID);if(!info){info=new Element('div',{id:'content_'+tagID}).update(tag.content);document.body.appendChild(info);}
info.setStyle({'position':'absolute','color':'white','background':'black','left':(x+width+pos.left)+'px','top':(y+pos.top)+'px','display':'block','zIndex':4});},reset:function(){this.cropImg.remove();this.controlPanel.hide();Event.observe(this.photo,'mousemove',this.mousemoveBind);}});Iyxzone.Photo.Slide=Class.create({initialize:function(photoType,currentID,ids,urls,frames,downBtn,upBtn){this.photoType=photoType+'s';this.downBtn=downBtn;this.upBtn=upBtn;this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.blankImage=new Image();this.blankImage.src='/images/photo/nopic50x50.png';this.urls=urls;this.ids=ids;this.currentID=currentID;this.idPos=0;this.mappings=new Hash();this.frames=frames;this.upTimer=null;this.downTimer=null;for(var i=0;i<this.ids.length;i++){if(this.ids[i]==this.currentID){this.idPos=i;break;}}
var pos=Math.floor(frames.length/2);for(var i=0;i<this.frames.length;i++){var p=(this.idPos+i-pos);if(p>=0&&p<this.ids.length){this.loadImage(i,p);}else{this.setBlank(i);}}
this.setBtnEvents();this.changeBtn();},setBtnEvents:function(){this.downBtn.observe('click',this.scrollDown.bindAsEventListener(this));this.upBtn.observe('click',this.scrollUp.bindAsEventListener(this));},changeBtn:function(){if(this.idPos==0){this.downBtn.className='btn downbtn-gray';}else{this.downBtn.className='btn downbtn';}
if(this.idPos==this.ids.length-1){this.upBtn.className='btn upbtn-gray';}else{this.upBtn.className='btn upbtn';}},setBlank:function(idx){this.frames[idx].innerHTML="<a href='#'><img src='"+this.blankImage.src+"' class='imgbox01'/></a>";},loadImage:function(idx,photoIdx){this.frames[idx].innerHTML="<img src='"+this.loadingImage.src+"'/>";var img=this.mappings.get(this.ids[photoIdx]);if(!img){img=new Image();img.src=this.urls[photoIdx];this.mappings.set(this.ids[photoIdx],img);}
if(this.currentID==this.ids[photoIdx]){this.frames[idx].addClassName('now');}
this.frames[idx].innerHTML="<a href='"+Iyxzone.SiteURL+"/"+this.photoType+"/"+this.ids[photoIdx]+"'><img src='"+img.src+"' class='imgbox01' width='50px' height='50px'/></a>";},scrollDown:function(){if(this.idPos==0||this.downTimer!=null){return;}
var div=this.frames[0].up();new Effect.Morph(div,{style:'top: 0px',duration:0.5});this.downTimer=setTimeout(this.afterScrollDown.bind(this),550);this.idPos--;this.changeBtn();},afterScrollDown:function(){var frame=new Element('div',{'class':'img'});Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();var p=this.idPos-Math.floor((this.frames.length-1)/2);if(p>=0){this.loadImage(0,p);}else{this.setBlank(0);}
frame.up().setStyle({'top':'-67px'});var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);this.downTimer=null;},scrollUp:function(){if(this.idPos==this.ids.length-1||this.upTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'top: -134px',duration:0.5});this.upTimer=setTimeout(this.afterScrollUp.bind(this),550);this.idPos++;this.changeBtn();},afterScrollUp:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({'top':'-67px'});var frame=new Element('div',{'class':'img'});Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();var p=this.idPos+this.frames.length-2-Math.floor((this.frames.length-3)/2);if(p<this.ids.length){this.loadImage(this.frames.length-1,p);}else{this.setBlank(this.frames.length-1);}
this.upTimer=null;}});Iyxzone.Photo.Slide2=Class.create({initialize:function(photoType,ids,urls,frames,leftBtn,rightBtn){this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.photoType=photoType+'s';this.ids=ids;this.urls=urls;this.frames=frames;this.leftBtn=leftBtn;this.rightBtn=rightBtn;this.idPos=1;for(var i=0;i<frames.length;i++){if(i>=0&&i<ids.length)
this.load(i,i);}
this.rightBtn.observe('click',this.scrollRight.bindAsEventListener(this));this.leftBtn.observe('click',this.scrollLeft.bindAsEventListener(this));},load:function(idx,photoIdx){if(photoIdx<0){photoIdx=(photoIdx+this.ids.length)%this.ids.length;}else if(photoIdx>=this.ids.length){photoIdx=(photoIdx)%this.ids.length;}
this.frames[idx].innerHTML='<img src="'+this.loadingImage.src+'" class="imgbox01"/>';this.frames[idx].innerHTML='<img src="'+this.urls[photoIdx]+'" class="imgbox01"/>';this.frames[idx].writeAttribute('href','/'+this.photoType+'/'+this.ids[photoIdx]);},scrollRight:function(){if(this.rightTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: 0px',duration:0.5});this.rightTimer=setTimeout(this.afterScrollRight.bind(this),550);this.idPos=(this.idPos-1+this.ids.length)%this.ids.length;},afterScrollRight:function(){var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);var frame=new Element('a');Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();this.load(0,this.idPos-1);frame.up().setStyle({left:'-136px'});this.rightTimer=null;},scrollLeft:function(){if(this.leftTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: -272px',duration:0.5});this.leftTimer=setTimeout(this.afterScrollLeft.bind(this),550);this.idPos=(this.idPos+1)%this.ids.length;},afterScrollLeft:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({left:'-136px'});var frame=new Element('a');Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();this.load(this.frames.length-1,this.idPos+this.frames.length);this.leftTimer=null;}});Iyxzone.Guild={version:'1.0',author:['高侠鸿'],Builder:{},Feeder:{},Editor:{},MemberManager:{}};Object.extend(Iyxzone.Guild.MemberManager,{currentID:null,currentStatus:null,guildID:null,roleList:null,startObserving:function(field){this.field=field;this.timer=setTimeout(this.search.bind(this),300);},stopObserving:function(field){clearTimeout(this.timer);},search:function(){var val=this.field.value;var ul=$('members');ul.childElements().each(function(li){var pinyin=li.readAttribute('pinyin');var name=li.readAttribute('name');if(pinyin.include(val)||name.include(val)){li.show();}else{li.hide();}}.bind(this));this.timer=setTimeout(this.search.bind(this),300);},buildRoleList:function(){this.roleList=new Element('div',{'class':'drop-wrap'});var div=new Element('div',{'class':'wrap-bg'});var dl=new Element('dl');var dd=new Element('dd',{'class':'jt-cutline'});var veteran=new Element('a',{href:'javascript:void(0)'}).update('工会长老');var member=new Element('a',{href:'javascript:void(0)'}).update('普通会员');dd.appendChild(veteran);dd.appendChild(member);dl.appendChild(dd);this.roleList.appendChild(div);this.roleList.appendChild(dl);document.observe('click',function(){this.roleList.hide();}.bind(this));veteran.observe('click',function(event){Event.stop(event);this.changeRole(4);}.bind(this));member.observe('click',function(event){Event.stop(event);this.changeRole(5);}.bind(this));},toggleRoleList:function(membershipID,status,event,span){Event.stop(event);if(this.isChanging){return;}
if(this.roleList){if(this.currentID==membershipID){if(this.roleList.visible()){this.roleList.hide();this.currentID=null;this.currentStatus=null;}else{this.roleList.show();this.currentID=membershipID;this.currentStatus=status;}}else{if(this.roleList.visible()){Element.insert(span,{after:this.roleList});this.currentID=membershipID;this.currentStatus=status;}else{Element.insert(span,{after:this.roleList});this.roleList.show();this.currentID=membershipID;this.currentStatus=status;}}}else{this.buildRoleList();Element.insert(span,{after:this.roleList});this.currentID=membershipID;this.currentStatus=status;}},changeRole:function(status){if(this.isChanging){return;}
if(status==this.currentStatus){this.roleList.hide();}else{new Ajax.Request('/guilds/'+this.guildID+'/memberships/'+this.currentID,{method:'put',parameters:'status='+status,onLoading:function(){this.isChanging=true;Iyxzone.changeCursor('wait');this.roleList.hide();}.bind(this),onComplete:function(transport){this.isChanging=false;Iyxzone.changeCursor('default');$('member_status_'+this.currentID).writeAttribute('onclick',"Iyxzone.Guild.MemberManager.toggleRoleList("+this.currentID+", "+status+", event, $(this).up());");}.bind(this)});}}});Object.extend(Iyxzone.Guild.Builder,{validate:function(){if($('guild_name').value==''){error('名字不能为空');return false;}
if($('guild_character_id')&&$('guild_character_id').value==''){error('你必须选择作为会长的游戏角色');return false;}
if($('guild_name').value.length>=100){error('名字最长100个字符');return false;}
if($('guild_description').value==''){error('描述不能为空');return false;}
if($('guild_description').value.length>=1000){error('描述最多1000个字符');return false;}
return true;},save:function(form,button){Iyxzone.disableButton(button,'请等待..');if(this.validate()){form.submit();}else{Iyxzone.enableButton(button,'提交');}}});Object.extend(Iyxzone.Guild.Feeder,{idx:0,moreFeeds:function(guildID){$('more_feed').innerHTML='<img src="/images/loading.gif" />';new Ajax.Request('/guilds/'+guildID+'/more_feeds?idx='+this.idx,{method:'get',onSuccess:function(){this.idx++;}});}});Object.extend(Iyxzone.Guild.Editor,{showError:function(div,content){var span=new Element('span',{'class':'icon-warn'});$(div).update(content);Element.insert($(div),{'top':span});},clearError:function(div){$(div).innerHTML='';},loading:function(div,title){$(div).innerHTML="<div class='edit-toggle space edit'><h3 class='s_clear'><strong class='left'>"+title+"</strong><a class='right' href='#'>取消</a></h3><div class='formcontent con con2'><img src='/images/loading.gif'/></div></div>";},attendanceRulesHTML:null,editAttendanceRulesHTML:null,editAttendanceRules:function(guildID){this.attendanceRulesHTML=$('attendance_rule_frame').innerHTML;if(this.editAttendanceRulesHTML){$('attendance_rule_frame').update(this.editAttendanceRulesHTML);}else{new Ajax.Request('/guilds/'+guildID+'/rules?type=0',{method:'get',onLoading:function(){this.loading('attendance_rule_frame','出勤规则');}.bind(this),onSuccess:function(transport){this.editAttendanceRulesHTML=transport.responseText;$('attendance_rule_frame').update(transport.responseText);}.bind(this)});}},isPresenceOutcomeValid:function(){var div='presence_rule_error';var outcome=$('presence_outcome').value;this.clearError(div);if(outcome==''){this.showError(div,"不能为空");return false;}else{outcome=parseInt(outcome);if(!outcome){this.showError(div,"必须是个整数");return false;}else if(outcome<0){this.showError(div,"必须是正整数");return false;}}
return true},isAbsenceOutcomeValid:function(){var div='absence_rule_error';var outcome=$('absence_outcome').value;this.clearError(div);if(outcome==''){this.showError(div,"不能为空");return false;}else{outcome=parseInt(outcome);if(!outcome){this.showError(div,"必须是个整数");return false;}else if(outcome>0){this.showError(div,"必须是负数");return false;}}
return true},validateAttendanceRules:function(){var v1=this.isPresenceOutcomeValid();var v2=this.isAbsenceOutcomeValid();return v1&&v2;},updateAttendanceRules:function(guildID,form,button){Iyxzone.disableButton(button,'请等待..');if(this.validateAttendanceRules()){new Ajax.Request('/guilds/'+guildID+'/rules/create_or_update?type=0',{method:'post',parameters:form.serialize(),onSuccess:function(transport){$('attendance_rule_frame').update(transport.responseText);this.editAttendanceRulesHTML=null;}.bind(this)});}else{Iyxzone.enableButton(button,'完成');}},cancelEditAttendanceRules:function(guildID){$('attendance_rule_frame').update(this.attendanceRulesHTML);},basicRulesHTML:null,editBasicRulesHTML:null,basicRulesCount:0,delRuleIDs:new Array(),editBasicRules:function(guildID){this.basicRulesHTML=$('basic_rule_frame').innerHTML;if(this.editBasicRulesHTML){$('basic_rule_frame').update(this.editBasicRulesHTML);}else{new Ajax.Updater('basic_rule_frame','/guilds/'+guildID+'/rules?type=1',{method:'get',evalScripts:true,onLoading:function(){this.loading('basic_rule_frame','其他规则');}.bind(this),onSuccess:function(transport){this.editBasicRulesHTML=transport.responseText;}.bind(this)});}},newBasicRule:function(guildID,button){new Ajax.Updater('basic_rules','/guilds/'+guildID+'/rules/new?id='+this.basicRulesCount,{method:'get',insertion:'bottom',evalScripts:true,onSuccess:function(transport){}.bind(this)});this.basicRulesCount++;},isRuleReasonValid:function(ruleID,newRule){if(newRule)
prefix='new';else
prefix='existing';var div=prefix+'_rule_'+ruleID+'_reason_error';var reason=$('guild_'+prefix+'_rules_'+ruleID+'_reason').value;this.clearError(div);if(reason==''){this.showError(div,'原因不能为空');return false;}
return true;},isRuleOutcomeValid:function(ruleID,newRule){if(newRule)
prefix='new';else
prefix='existing';var div=prefix+'_rule_'+ruleID+'_outcome_error';var outcome=$('guild_'+prefix+'_rules_'+ruleID+'_outcome').value;this.clearError(div);if(outcome==''){this.showError(div,'结果不能为空');return false;}else if(!parseInt(outcome)){this.showError(div,'结果必须是整数');return false;}
return true;},validateBasicRules:function(form){var valid=true;var inputs=form.getInputs();inputs.each(function(input){if(input.type!='text')
return;var inputID=input.id;var newRule=null;if(inputID.match(/new/))
newRule=true;else
newRule=false;var id=inputID.match(/\d+/)[0];if(inputID.match(/reason/)){valid&=this.isRuleReasonValid(id,newRule);}else if(inputID.match(/outcome/)){valid&=this.isRuleOutcomeValid(id,newRule);}}.bind(this));return valid;},updateBasicRules:function(guildID,form,button){Iyxzone.disableButton(button,'请等待..');if(this.validateBasicRules(form)){var delParams='';for(var i=0;i<this.delRuleIDs.length;i++){delParams+="guild[del_rules][]="+this.delRuleIDs[i]+"&";}
new Ajax.Request('/guilds/'+guildID+'/rules/create_or_update?type=1',{method:'post',parameters:delParams+form.serialize(),onSuccess:function(transport){$('basic_rule_frame').update(transport.responseText);this.editBasicRulesHTML=null;this.delRuleIDs=new Array();this.basicRules=new Hash();}.bind(this)});}else{Iyxzone.enableButton(button,'完成');}},cancelEditBasicRules:function(guildID){$('basic_rule_frame').update(this.basicRulesHTML);this.delRuleIDs=new Array();},removeBasicRule:function(ruleID,newRule,div){if(newRule)
prefix='new';else
prefix='existing';if(!newRule)
this.delRuleIDs.push(ruleID);$(prefix+'_rule_'+ruleID).remove();},bossesHTML:null,editBossesHTML:null,bossesCount:0,delBossIDs:new Array(),editBosses:function(guildID){this.bossesHTML=$('boss_frame').innerHTML;this.loading('boss_frame','BOSS');if(this.editBossesHTML){$('boss_frame').update(this.editBossesHTML);}else{new Ajax.Updater('boss_frame','/guilds/'+guildID+'/bosses',{method:'get',evalScripts:true,onSuccess:function(transport){this.editBossesHTML=transport.responseText;}.bind(this)});}},newBoss:function(guildID){new Ajax.Updater('guild_bosses','/guilds/'+guildID+'/bosses/new?id='+this.bossesCount,{method:'get',evalScripts:true,insertion:'bottom',onSuccess:function(transport){}.bind(this)});this.bossesCount++;},isBossNameValid:function(bossID,newBoss){if(newBoss)
prefix='new';else
prefix='existing';var div=prefix+'_boss_'+bossID+'_name_error';var name=$('guild_'+prefix+'_bosses_'+bossID+'_name').value;this.clearError(div);if(name==''){this.showError(div,'名字不能为空');return false;}
return true;},isBossRewardValid:function(bossID,newBoss){if(newBoss)
prefix='new';else
prefix='existing';var div=prefix+'_boss_'+bossID+'_reward_error';var reward=$('guild_'+prefix+'_bosses_'+bossID+'_reward').value;this.clearError(div);if(reward==''){this.showError(div,'奖励不能为空');return false;}else{reward=parseInt(reward);if(!reward){this.showError(div,'奖励不合法');return false;}else if(reward<=0){this.showError(div,'奖励必须是正数');return false;}}
return true;},validateBosses:function(form){var valid=true;var inputs=form.getInputs();inputs.each(function(input){if(input.type!='text')
return;var inputID=input.id;var newBoss=null;if(inputID.match(/new/))
newBoss=true;else
newBoss=false;var id=inputID.match(/\d+/)[0];if(inputID.match(/name/))
valid&=this.isBossNameValid(id,newBoss);else
valid&=this.isBossRewardValid(id,newBoss);}.bind(this));return valid;},updateBosses:function(guildID,form,button){Iyxzone.disableButton(button,'请等待..');if(this.validateBosses(form)){var delParams='';for(var i=0;i<this.delBossIDs.length;i++){delParams+="guild[del_bosses][]="+this.delBossIDs[i]+"&";}
new Ajax.Updater('boss_frame','/guilds/'+guildID+'/bosses/create_or_update',{method:'post',parameters:delParams+form.serialize(),onSuccess:function(transport){this.editBossesHTML=null;this.delBossIDs=new Array();}.bind(this)});}else{Iyxzone.enableButton(button,'完成');}},cancelEditBosses:function(guildID){$('boss_frame').update(this.bossesHTML);this.delBossIDs=new Array();},removeBoss:function(bossID,newBoss){if(newBoss)
prefix='new';else
prefix='existing';if(!newBoss)
this.delBossIDs.push(bossID);$(prefix+'_boss_'+bossID).remove();},gearsHTML:null,editGearsHTML:null,gearsCount:0,delGearIDs:new Array(),editGears:function(guildID){this.gearsHTML=$('gear_frame').innerHTML;if(this.editGearsHTML){$('gear_frame').update(this.editGearsHTML);}else{new Ajax.Updater('gear_frame','/guilds/'+guildID+'/gears',{method:'get',evalScripts:true,onLoading:function(){this.loading('gear_frame','装备');}.bind(this),onSuccess:function(transport){this.editGearsHTML=transport.responseText;}.bind(this)});}},newGear:function(guildID){new Ajax.Updater('guild_gears','/guilds/'+guildID+'/gears/new?id='+this.gearsCount,{method:'get',evalScripts:true,insertion:'bottom',onSuccess:function(transport){}.bind(this)});this.gearsCount++;},isGearNameValid:function(gearID,newGear){if(newGear)
prefix='new';else
prefix='existing';var div=prefix+'_gear_'+gearID+'_name_error';var name=$('guild_'+prefix+'_gears_'+gearID+'_name').value;this.clearError(div);if(name==''){this.showError(div,'名字不能为空');return false;}
return true;},isGearCostValid:function(gearID,newGear){if(newGear)
prefix='new';else
prefix='existing';var div=prefix+'_gear_'+gearID+'_cost_error';var cost=$('guild_'+prefix+'_gears_'+gearID+'_cost').value;this.clearError(div);if(cost==''){this.showError(div,'奖励不能为空');return false;}else{cost=parseInt(cost);if(!cost){this.showError(div,'奖励不合法');return false;}else if(cost<=0){this.showError(div,'奖励必须是正数');return false;}}
return true;},validateGears:function(form){var valid=true;var inputs=form.getInputs();inputs.each(function(input){if(input.type!='text')
return;var inputID=input.id;var newGear=null;if(inputID.match(/new/))
newGear=true;else
newGear=false;var id=inputID.match(/\d+/)[0];if(inputID.match(/name/))
valid&=this.isGearNameValid(id,newGear);else
valid&=this.isGearCostValid(id,newGear);}.bind(this));return valid;},updateGears:function(guildID,form,button){Iyxzone.disableButton(button,'请等待..');if(this.validateGears(form)){var delParams='';for(var i=0;i<this.delGearIDs.length;i++){delParams+="guild[del_gears][]="+this.delGearIDs[i]+"&";}
this.updateGearRequest=new Ajax.Request('/guilds/'+guildID+'/gears/create_or_update',{method:'post',parameters:delParams+form.serialize(),onSuccess:function(transport){$('gear_frame').update(transport.responseText);this.editGearsHTML=null;this.delGearIDs=new Array();}.bind(this)});}else{Iyxzone.enableButton(button,'完成');}},cancelEditGears:function(guildID){$('gear_frame').update(this.gearsHTML);this.delGearIDs=new Array();},removeGear:function(gearID,newGear){if(newGear)
prefix='new';else
prefix='existing';if(!newGear)
this.delGearIDs.push(gearID);$(prefix+'_gear_'+gearID).remove();}});