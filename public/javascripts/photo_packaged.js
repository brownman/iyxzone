Iyxzone.Photo={version:'1.0',author:['高侠鸿'],Tagger:Class.create({}),SlideManager:{},Slide:Class.create({}),Slide2:Class.create({})};Iyxzone.Photo.FriendSelector=Class.create({initialize:function(toggleButton,input,friendList,friendTable,friendItems,gameSelector,token){this.friendID=0;this.toggleButton=$(toggleButton);this.friendList=$(friendList);this.friendTable=$(friendTable);this.friendItems=$(friendItems);this.gameSelector=$(gameSelector);this.token=token;Event.observe(this.toggleButton,'click',function(e){this.toggleFriends();}.bind(this));Event.observe(this.gameSelector,'change',function(){this.getFriends();}.bind(this));this.textboxList=new TextBoxList(input,{onBoxDispose:this.removeBox.bind(this),holderClassName:'friend-select-list s_clear',bitClassName:''});var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;inputs[i].observe('click',this.afterCheckFriend.bindAsEventListener(this));}}
var pinyins=[];var names=[];var ids=[];this.friendItems.childElements().each(function(li){pinyins.push(li.down('input').readAttribute('pinyin'));names.push(li.down('input').readAttribute('login'));ids.push(li.down('input').value);}.bind(this));new Iyxzone.Friend.Autocompleter(this.textboxList.getMainInput(),this.friendList,{ids:ids,names:names,pinyins:pinyins,emptyText:'没有匹配的好友...',tipText:'输入你好友的姓名或者拼音',afterUpdateElement:this.afterSelectFriend.bind(this),comp:this.textboxList.holder});},removeBox:function(el,input){var friendID=input.value;this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}},add:function(info){if(this.textboxList.bits.size()!=0){this.textboxList.disposeAll();}
this.textboxList.add(info.id,info.login);this.friendID=info.id;},getFriends:function(){var gameID=this.gameSelector.value;var friends=this.friendItems.childElements();friends.each(function(f){var info=f.readAttribute('info').evalJSON();var games=info.games;if(gameID=='all'||games.include(gameID)){f.show();}else{f.hide();}}.bind(this));},toggleFriends:function(){if(!this.friendTable.visible()){var pos=this.toggleButton.positionedOffset();this.friendTable.setStyle({position:'absolute',left:(pos.left+this.toggleButton.getWidth()-this.friendTable.getWidth())+'px',top:(pos.top+this.toggleButton.getHeight())+'px'});this.friendTable.show();}else{this.friendTable.hide();}},afterSelectFriend:function(input,selectedLI){var id=selectedLI.readAttribute('id');var login=selectedLI.childElements()[0].innerHTML;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;if(inputs[i].value==id)
inputs[i].checked=true;}}
this.add({id:id,login:login});input.clear();},afterCheckFriend:function(mouseEvent){var checkbox=mouseEvent.target;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i]!=checkbox){inputs[i].checked=false;}}
this.toggleFriends();this.add({id:checkbox.value,login:checkbox.readAttribute('login')});},reset:function(){this.textboxList.getMainInput().clear();this.textboxList.disposeAll();this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}}});Iyxzone.Photo.Tagger=Class.create({initialize:function(type,photoID,controlPanel,confirmButton,cancelButton,tagInfos,tagsHolder,isCurrentUser,contentInput,toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token,options){this.options=Object.extend({ratio:0.2},options||{});this.type=type;this.photoID=photoID;this.photo=$('photo_'+this.photoID);this.controlPanel=$(controlPanel);this.contentInput=$(contentInput);this.confirmButton=$(confirmButton);this.cancelButton=$(cancelButton);this.tagInfos=new Hash();this.tagsHolder=$(tagsHolder);this.isCurrentUser=isCurrentUser;this.token=token;this.started=false;this.isLoading=true;if(tagInfos.length!=0)
this.tagsHolder.innerHTML='<img src="/images/loading.gif" />';for(var i=0;i<tagInfos.length;i++){this.insertTag(tagInfos[i]);}
this.friendSelector=new Iyxzone.Photo.FriendSelector(toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token);Event.observe(this.confirmButton,'click',function(e){Event.stop(e);this.save();}.bind(this));Event.observe(this.cancelButton,'click',function(e){Event.stop(e);this.reset();this.started=false;}.bind(this));this.mousemoveBind=this.showNearestTagWithContent.bindAsEventListener(this);Event.observe(this.photo,'mousemove',this.mousemoveBind);},insertTag:function(tagInfo){this.tagInfos.set(tagInfo.photo_tag.id,{id:tagInfo.photo_tag.id,width:tagInfo.photo_tag.width,height:tagInfo.photo_tag.height,left:tagInfo.photo_tag.x,top:tagInfo.photo_tag.y,content:tagInfo.photo_tag.content,tagged_user_id:tagInfo.photo_tag.tagged_user.id,tagged_user_login:tagInfo.photo_tag.tagged_user.login,poster_id:tagInfo.photo_tag.poster.id,poster_login:tagInfo.photo_tag.poster.login});var li=new Element('li',{id:'tag_'+tagInfo.photo_tag.id});var rectTag=new Element('strong');var posterLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.poster.id}).update(tagInfo.photo_tag.poster.login);var taggedUserLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.tagged_user.id}).update(tagInfo.photo_tag.tagged_user.login);rectTag.appendChild(posterLink);rectTag.innerHTML+=('标记了');rectTag.appendChild(taggedUserLink);rectTag.innerHTML+=(' : '+tagInfo.photo_tag.content);li.appendChild(rectTag);if(this.isLoading){this.tagsHolder.innerHTML='';Element.insert(this.tagsHolder,{bottom:li});this.isLoading=false;}else{Element.insert(this.tagsHolder,{bottom:li});}
Event.observe('tag_'+tagInfo.photo_tag.id,'mouseover',function(e){this.showTagWithContent(tagInfo.photo_tag.id);}.bind(this));Event.observe('tag_'+tagInfo.photo_tag.id,'mouseout',function(e){this.hideTagWithContent(tagInfo.photo_tag.id);}.bind(this));if(this.isCurrentUser){var deleteLink=new Element('a',{href:'javascript: void(0)','class':'icon-active'});var spaceBar=new Element('span');li.appendChild(deleteLink);li.appendChild(spaceBar);deleteLink.observe('click',function(e){facebox.show_confirm_with_callbacks('你确定要删除这个标价吗?',this.remove.bind(this),tagInfo.photo_tag.id);}.bind(this));}},start:function(){if(this.started){return;}
var min=0;if(this.photo.getWidth()<this.photo.getHeight()){min=this.photo.getWidth()*this.options.ratio;}else{min=this.photo.getHeight()*this.options.ratio;}
this.cropImg=new Cropper.Img('photo_'+this.photoID,{onDragging:this.onDragging.bind(this),minWidth:min,minHeight:min,displayOnInit:true,onloadCoords:{x1:this.photo.getWidth()-min,y1:0,x2:this.photo.getWidth(),y2:min}});this.onDragging({x1:this.photo.getWidth()-min,y1:0},{width:min,height:min});Event.stopObserving(this.photo,'mousemove',this.mousemoveBind);this.started=true;},onDragging:function(coords,dimensions){var pos=Element.cumulativeOffset(this.photo);this.controlPanel.setStyle({position:'absolute',left:(pos.left+coords.x1+dimensions.width+2)+'px',top:(pos.top+coords.y1)+'px',zIndex:200});this.controlPanel.show();},validate:function(){if(this.friendSelector.friendID==0){error('你需要选择一个好友');return false;}
return true;},remove:function(tagID){new Ajax.Request('/photo_tags/'+tagID,{method:'delete',parameters:'authenticity_token='+encodeURIComponent(this.token),onSuccess:function(transport){if($('square_'+tagID))$('square_'+tagID).remove();if($('content_'+tagID))$('content_'+tagID).remove();$('tag_'+tagID).remove();this.tagInfos.unset(tagID);}.bind(this)});},save:function(){if(this.validate()){var params="";params=$('tag_form').serialize();params+="&tag[tagged_user_id]="+this.friendSelector.friendID;params+="&tag[x]="+this.cropImg.areaCoords.x1;params+="&tag[y]="+this.cropImg.areaCoords.y1;params+="&tag[width]="+this.cropImg.calcW();params+="&tag[height]="+this.cropImg.calcH();params+="&tag[photo_id]="+this.photoID;params+="&tag[photo_type]="+this.type;alert(params);new Ajax.Request('/photo_tags',{method:'post',parameters:params,onSuccess:function(transport){this.friendSelector.reset();this.contentInput.clear();var tagInfo=transport.responseText.evalJSON();this.insertTag(tagInfo);}.bind(this)});}},showNearestTagWithContent:function(event){var distance=100000000;var tagID=-1;var photoX=this.photo.positionedOffset().left;var photoY=this.photo.positionedOffset().top;var mouseX=event.pointerX();var mouseY=event.pointerY();this.tagInfos.each(function(pair){var x=photoX+pair.value.left;var width=pair.value.width;var y=photoY+pair.value.top;var height=pair.value.height;if(mouseX>=x&&mouseX<=x+width&&mouseY>=y&&mouseY<=y+height){var deltaX=(x+width/2)-mouseX;var deltaY=(y+height/2)-mouseY;var delta=((x+width/2)-mouseX)*((x+width/2)-mouseX)+((y+height/2)-mouseY)*((y+height/2)-mouseY);if(delta<distance){distance=delta;tagID=pair.key;}}else{if(pair.key==this.currentTagID){this.hideTagWithContent(this.currentTagID);this.currentTagID=-1;}}}.bind(this));if(tagID>=0){this.currentTagID=tagID;this.showTagWithContent(tagID);}},hideTagWithContent:function(tagID){var square=$('square_'+tagID);var info=$('content_'+tagID);if(square)square.hide();if(info)info.hide();},showTagWithContent:function(tagID){var tag=this.tagInfos.get(tagID);var pos=this.photo.positionedOffset();var x=tag.left;var y=tag.top;var width=tag.width;var height=tag.height;var square=$('square_'+tagID);if(!square){square=new Element('div',{className:'square-class',id:'square_'+tagID});document.body.appendChild(square);}
square.setStyle({'position':'absolute','width':width+'px','height':height+'px','left':(x+pos.left)+'px','top':(y+pos.top)+'px','border':'2px solid #eeeeee','display':'block','zIndex':4});var info=$('content_'+tagID);if(!info){info=new Element('div',{id:'content_'+tagID}).update(tag.content);document.body.appendChild(info);}
info.setStyle({'position':'absolute','color':'white','background':'black','left':(x+width+pos.left)+'px','top':(y+pos.top)+'px','display':'block','zIndex':4});},reset:function(){this.cropImg.remove();this.controlPanel.hide();Event.observe(this.photo,'mousemove',this.mousemoveBind);}});Iyxzone.Photo.Slide=Class.create({initialize:function(photoType,currentID,ids,urls,frames,downBtn,upBtn){this.photoType=photoType+'s';this.downBtn=downBtn;this.upBtn=upBtn;this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.blankImage=new Image();this.blankImage.src='/images/photo/nopic50x50.png';this.urls=urls;this.ids=ids;this.currentID=currentID;this.idPos=0;this.mappings=new Hash();this.frames=frames;this.upTimer=null;this.downTimer=null;for(var i=0;i<this.ids.length;i++){if(this.ids[i]==this.currentID){this.idPos=i;break;}}
var pos=Math.floor(frames.length/2);for(var i=0;i<this.frames.length;i++){var p=(this.idPos+i-pos);if(p>=0&&p<this.ids.length){this.loadImage(i,p);}else{this.setBlank(i);}}
this.setBtnEvents();this.changeBtn();},setBtnEvents:function(){this.downBtn.observe('click',this.scrollDown.bindAsEventListener(this));this.upBtn.observe('click',this.scrollUp.bindAsEventListener(this));},changeBtn:function(){if(this.idPos==0){this.downBtn.className='btn downbtn-gray';}else{this.downBtn.className='btn downbtn';}
if(this.idPos==this.ids.length-1){this.upBtn.className='btn upbtn-gray';}else{this.upBtn.className='btn upbtn';}},setBlank:function(idx){this.frames[idx].innerHTML="<a href='#'><img src='"+this.blankImage.src+"' class='imgbox01'/></a>";},loadImage:function(idx,photoIdx){this.frames[idx].innerHTML="<img src='"+this.loadingImage.src+"'/>";var img=this.mappings.get(this.ids[photoIdx]);if(!img){img=new Image();img.src=this.urls[photoIdx];this.mappings.set(this.ids[photoIdx],img);}
if(this.currentID==this.ids[photoIdx]){this.frames[idx].addClassName('now');}
this.frames[idx].innerHTML="<a href='"+Iyxzone.SiteURL+"/"+this.photoType+"/"+this.ids[photoIdx]+"'><img src='"+img.src+"' class='imgbox01' width='50px' height='50px'/></a>";},scrollDown:function(){if(this.idPos==0||this.downTimer!=null){return;}
var div=this.frames[0].up();new Effect.Morph(div,{style:'top: 0px',duration:0.5});this.downTimer=setTimeout(this.afterScrollDown.bind(this),550);this.idPos--;this.changeBtn();},afterScrollDown:function(){var frame=new Element('div',{'class':'img'});Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();var p=this.idPos-Math.floor((this.frames.length-1)/2);if(p>=0){this.loadImage(0,p);}else{this.setBlank(0);}
frame.up().setStyle({'top':'-67px'});var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);this.downTimer=null;},scrollUp:function(){if(this.idPos==this.ids.length-1||this.upTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'top: -134px',duration:0.5});this.upTimer=setTimeout(this.afterScrollUp.bind(this),550);this.idPos++;this.changeBtn();},afterScrollUp:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({'top':'-67px'});var frame=new Element('div',{'class':'img'});Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();var p=this.idPos+this.frames.length-2-Math.floor((this.frames.length-3)/2);if(p<this.ids.length){this.loadImage(this.frames.length-1,p);}else{this.setBlank(this.frames.length-1);}
this.upTimer=null;}});Iyxzone.Photo.Slide2=Class.create({initialize:function(photoType,ids,urls,frames,leftBtn,rightBtn){this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.photoType=photoType+'s';this.ids=ids;this.urls=urls;this.frames=frames;this.leftBtn=leftBtn;this.rightBtn=rightBtn;this.idPos=1;for(var i=0;i<frames.length;i++){if(i>=0&&i<ids.length)
this.load(i,i);}
this.rightBtn.observe('click',this.scrollRight.bindAsEventListener(this));this.leftBtn.observe('click',this.scrollLeft.bindAsEventListener(this));},load:function(idx,photoIdx){if(photoIdx<0){photoIdx=(photoIdx+this.ids.length)%this.ids.length;}else if(photoIdx>=this.ids.length){photoIdx=(photoIdx)%this.ids.length;}
this.frames[idx].innerHTML='<img src="'+this.loadingImage.src+'" class="imgbox01"/>';this.frames[idx].innerHTML='<img src="'+this.urls[photoIdx]+'" class="imgbox01"/>';this.frames[idx].writeAttribute('href','/'+this.photoType+'/'+this.ids[photoIdx]);},scrollRight:function(){if(this.rightTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: 0px',duration:0.5});this.rightTimer=setTimeout(this.afterScrollRight.bind(this),550);this.idPos=(this.idPos-1+this.ids.length)%this.ids.length;},afterScrollRight:function(){var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);var frame=new Element('a');Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();this.load(0,this.idPos-1);frame.up().setStyle({left:'-136px'});this.rightTimer=null;},scrollLeft:function(){if(this.leftTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: -272px',duration:0.5});this.leftTimer=setTimeout(this.afterScrollLeft.bind(this),550);this.idPos=(this.idPos+1)%this.ids.length;},afterScrollLeft:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({left:'-136px'});var frame=new Element('a');Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();this.load(this.frames.length-1,this.idPos+this.frames.length);this.leftTimer=null;}});Iyxzone.Friend={version:'1.0',author:['高侠鸿'],Suggestor:{},NicerSuggestor:{},Tagger:Class.create({})};Iyxzone.Comrade={version:'1.0',author:['高侠鸿'],Suggestor:{}};Object.extend(Iyxzone.Friend.Suggestor,{newSuggestion:function(suggestionID,token){var url='friend_suggestions/new';var exceptIDs=[];var suggestions=$('friend_suggestions').childElements();for(var i=0;i<suggestions.length;i++){exceptIDs.push(suggestions[i].readAttribute('suggestion_id'));}
var exceptParam="";for(var i=0;i<exceptIDs.length;i++){exceptParam+="except_ids[]="+exceptIDs[i]+"&";}
url+="?"+exceptParam;new Ajax.Request(url,{method:'get',parameters:{authenticity_token:encodeURIComponent(token)},onSuccess:function(transport){var card=$('friend_suggestion_'+suggestionID);var temp_parent=new Element('div');temp_parent.innerHTML=transport.responseText;var li=temp_parent.childElements()[0];li.hide();Element.replace(card,li);li.appear({duration:3.0});}.bind(this)});}});Object.extend(Iyxzone.Friend.NicerSuggestor,{newSuggestion:function(suggestionID,token){var url='friend_suggestions/new';var exceptIDs=[];var suggestions=$('friend_suggestions').childElements();for(var i=0;i<suggestions.length;i++){exceptIDs.push(suggestions[i].readAttribute('suggestion_id'));}
var exceptParam="";for(var i=0;i<exceptIDs.length;i++){exceptParam+="except_ids[]="+exceptIDs[i]+"&";}
url+="?"+exceptParam;new Ajax.Request(url,{method:'get',parameters:{authenticity_token:encodeURIComponent(token),nicer:1},onSuccess:function(transport){var card=$('friend_suggestion_'+suggestionID);var temp_parent=new Element('div');temp_parent.innerHTML=transport.responseText;var li=temp_parent.childElements()[0];li.hide();Element.replace(card,li);li.appear({duration:3.0});}.bind(this)});}});Object.extend(Iyxzone.Comrade.Suggestor,{newSuggestion:function(serverID,suggestionID,token){var url='friend_suggestions/new';var exceptIDs=[];var suggestions=$('server_'+serverID+'_suggestions').childElements();for(var i=0;i<suggestions.length;i++){exceptIDs.push(suggestions[i].readAttribute('suggestion_id'));}
var exceptParam="";for(var i=0;i<exceptIDs.length;i++){exceptParam+="except_ids[]="+exceptIDs[i]+"&";}
url+="?"+exceptParam;new Ajax.Request(url,{method:'get',parameters:{server_id:serverID,authenticity_token:encodeURIComponent(token)},onSuccess:function(transport){var card=$('comrade_suggestion_'+suggestionID);var temp_parent=new Element('div');temp_parent.innerHTML=transport.responseText;var li=temp_parent.childElements()[0];li.hide();Element.replace(card,li);li.appear({duration:3.0});}.bind(this)});}});Iyxzone.Friend.Autocompleter=Class.create(Autocompleter.Local,{initialize:function($super,element,update,options){options=Object.extend({selector:function(instance){var options=instance.options;var pinyins=options.pinyins;var names=options.names;var ids=options.ids;var token=instance.getToken();var ret=[];for(var i=0;i<pinyins.length;i++){var pinyinPos=options.ignoreCase?pinyins[i].toLowerCase().indexOf(token.toLowerCase()):pinyins[i].indexOf(token);var namePos=options.ignoreCase?names[i].toLowerCase().indexOf(token.toLowerCase()):names[i].indexOf(token);if(pinyinPos>=0||namePos>=0){ret.push('<li style="list-style-type:none;" id='+ids[i]+' ><a href="javascript:void(0)">'+names[i]+'</a></li>');}}
if(ret.length==0){return options.emptyText;}else{return"<ul>"+ret.join('')+"</ul>";}}},options||{});Event.observe(element,'focus',this.showTip.bindAsEventListener(this));$super(element,update,null,options);},showTip:function(){this.update.innerHTML=this.options.tipText;var comp=this.options.comp;this.update.setStyle({position:'absolute',left:comp.positionedOffset().left+'px',top:(comp.positionedOffset().top+comp.getHeight())+'px',width:(comp.getWidth()-10)+'px',maxHeight:'200px',overflow:'auto',padding:'5px',background:'white',border:'1px solid #E7F0E0'});this.update.show();},updateChoices:function($super,data){if(data.indexOf('ul')<0){this.update.innerHTML=data;this.update.show();}else{$super(data);}
var comp=this.options.comp;this.update.setStyle({position:'absolute',left:comp.positionedOffset().left+'px',top:(comp.positionedOffset().top+comp.getHeight())+'px',width:(comp.getWidth()-10)+'px',maxHeight:'200px',overflow:'auto',padding:'5px',background:'white',border:'1px solid #E7F0E0'});}});Iyxzone.Friend.Tagger=Class.create({initialize:function(max,friendIDs,tagIDs,friendNames,toggleButton,input,friendList,friendTable,friendItems,gameSelector,confirmButton,cancelButton){this.max=max;this.tags=new Hash();this.newTags=new Hash();this.delTags=new Array();this.toggleButton=$(toggleButton);this.friendList=$(friendList);this.friendTable=$(friendTable);this.friendItems=$(friendItems);this.confirmButton=$(confirmButton);this.cancelButton=$(cancelButton);this.gameSelector=$(gameSelector);this.taggedUserList=new TextBoxList(input,{onBoxDispose:this.removeBox.bind(this),holderClassName:'friend-select-list s_clear',bitClassName:''});for(var i=0;i<friendIDs.length;i++){var el=this.taggedUserList.add(friendIDs[i],friendNames[i]);this.tags.set(friendIDs[i],[tagIDs[i],el]);}
var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;inputs[i].observe('click',this.afterCheckFriend.bindAsEventListener(this));if(this.tags.keys().include(inputs[i].value)){inputs[i].checked=true;}}}
Event.observe(this.toggleButton,'click',function(e){this.toggleFriends();}.bind(this));Event.observe(this.confirmButton,'click',function(event){Event.stop(event);var checked=new Hash();var delTags=new Array();var newTags=new Array();var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].checked){checked.set(inputs[i].value,{id:inputs[i].value,login:inputs[i].readAttribute('login')});}}
this.tags.keys().each(function(key){if(!checked.keys().include(key)){delTags.push(key);}}.bind(this));this.newTags.keys().each(function(key){if(!checked.keys().include(key)){delTags.push(key);}}.bind(this));this.removeTags(delTags);var tagIDs=this.tags.keys();var newTagIDs=this.newTags.keys();checked.each(function(pair){var input=pair.value;var key=pair.key;if(!tagIDs.include(key)&&!newTagIDs.include(key)){newTags.push(input);}}.bind(this));this.addTags(newTags);this.toggleFriends();}.bind(this));Event.observe(this.cancelButton,'click',function(event){Event.stop(event);this.toggleFriends();}.bind(this));Event.observe(this.gameSelector,'change',function(e){this.getFriends(this.gameSelector.value);}.bind(this));var pinyins=[];var names=[];var ids=[];this.friendItems.childElements().each(function(li){pinyins.push(li.down('input').readAttribute('pinyin'));names.push(li.down('input').readAttribute('login'));ids.push(li.down('input').value);}.bind(this));new Iyxzone.Friend.Autocompleter(this.taggedUserList.getMainInput(),this.friendList,{ids:ids,names:names,pinyins:pinyins,afterUpdateElement:this.afterSelectFriend.bind(this),tipText:'输入你好友的名字或者拼音',emptyText:'没有匹配的好友...',comp:this.taggedUserList.holder});},removeBox:function(el,input){var friendID=input.value;var tagInfo=this.tags.unset(friendID);if(tagInfo){this.delTags.push(tagInfo[0]);}else{this.newTags.unset(friendID);}
var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].value==friendID){inputs[i].checked=false;}}},removeTags:function(friendIDs){for(var i=0;i<friendIDs.length;i++){var friendID=friendIDs[i];var tagInfo=this.tags.unset(friendID);if(tagInfo){this.delTags.push(tagInfo[0]);tagInfo[1].remove();}else{var div=this.newTags.unset(friendID);div.remove();}}},addTags:function(friends){for(var i=0;i<friends.length;i++){var el=this.taggedUserList.add(friends[i].id,friends[i].login);this.newTags.set(friends[i].id,el);}},getNewTags:function(){return this.newTags.keys();},getDelTags:function(){return this.delTags;},getFriends:function(game_id){var friends=this.friendItems.childElements();friends.each(function(f){var info=f.readAttribute('info').evalJSON();var games=info.games;if(game_id=='all'||games.include(game_id)){f.show();}else{f.hide();}}.bind(this));},toggleFriends:function(){if(!this.friendTable.visible()){var pos=this.toggleButton.positionedOffset();this.friendTable.setStyle({position:'absolute',left:(pos.left+this.toggleButton.getWidth()-this.friendTable.getWidth())+'px',top:(pos.top+this.toggleButton.getHeight())+'px'});this.friendTable.show();}else{this.friendTable.hide();}},afterSelectFriend:function(input,selectedLI){var id=selectedLI.readAttribute('id');var login=selectedLI.childElements()[0].innerHTML;input.clear();if(this.tags.keys().include(id)||this.newTags.keys().include(id)){return;}else{if(this.tags.keys().length+this.newTags.keys().length>=this.max){error('最多选'+this.max+'个!');return;}
this.addTags([{id:id,login:login}]);input.clear();var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].value==id){inputs[i].checked=true;}}}},afterCheckFriend:function(mouseEvent){var checkbox=mouseEvent.target;if(!checkbox.checked){return;}
var inputs=$$('input');var checked=0;for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].checked)
checked++;}
if(checked>this.max){error('最多选'+this.max+'个!');checkbox.checked=false;return;}},reset:function(tagInfos){this.newTags.each(function(pair){var friendID=pair.key;var div=pair.value;for(var i=0;i<tagInfos.length;i++){if(tagInfos[i].friend_id==friendID){this.tags.set(friendID,[tagInfos[i].id,div])}}}.bind(this));this.delTags=new Array();this.newTags=new Hash();}});ResizableTextBox=Class.create({initialize:function(element,options){this.options=Object.extend({min:20,max:500,step:7},options||{});this.element=element;this.element.setStyle({width:this.options.min});Event.observe(this.element,'keyup',function(){var newSize=this.options.step*this.element.value.length;if(newSize>=this.options.max)
newSize=this.options.max;else if(newSize<=this.options.min)
newSize=this.options.min;else
newSize=newSize;this.element.setStyle({width:newSize+'px'});}.bind(this));},reset:function(){this.element.setStyle({width:this.options.min+'px'});}});TextBoxList=Class.create({initialize:function(element,options){this.options=Object.extend({holderClassName:'holder',bitClassName:'bit-box',paramName:'value[]',onMainInputFocus:Prototype.emptyFunction,onMainInputBlur:Prototype.emptyFunction,onBoxFocus:Prototype.emptyFunction,onBoxBlur:Prototype.emptyFunction,onBoxDispose:Prototype.emptyFunction},options||{});this.count=0;this.el=$(element);this.bits=new Hash();this.current=false;this.mainInput=this.createMainInput();this.holder=new Element('ul',{"class":this.options.holderClassName});this.el.hide();this.holder.appendChild(this.mainInput);Element.insert(this.el,{before:this.holder});this.resizableMainInput=new ResizableTextBox(this.inputTextField,{max:(this.holder.getWidth()||100)});Event.observe(this.mainInput,'click',function(e){this.mainInputFocus();Event.stop(e);}.bind(this));Event.observe(this.holder,'click',function(e){this.inputTextField.focus();this.mainInputFocus();Event.stop(e);}.bind(this));Event.observe(document,'keydown',function(e){}.bind(this));Event.observe(document,'keyup',function(e){switch(e.keyCode){case 37:if(!this.current||this.current==this.mainInput)return;this.boxFocus(this.getPrevious(this.current));break;case 39:if(!this.current||this.current==this.mainInput)return;this.boxFocus(this.getNext(this.current));break;case 8:if(!this.current||this.current==this.mainInput)return;this.dispose(this.current,e.keyCode);break;case 46:if(!this.current||this.current==this.mainInput)return;this.dispose(this.current,e.keyCode);break;}}.bind(this));Event.observe(document,'click',function(e){this.boxBlur();}.bind(this));},add:function(val,text){var id='bit-'+this.count++;var el=this.createBox(text,{id:id});Element.insert(this.mainInput,{before:el});var input=this.createInput({value:val});Element.insert(el,{before:input});input.hide();Event.observe(el,'click',function(e){this.boxFocus(el);Event.stop(e);}.bind(this));this.bits.set(id,text);this.resizableMainInput.reset();return el;},createBox:function(text,options){var li=new Element('li',Object.extend({"class":this.options.bitClassName},options||{}));var a=new Element('a');var span=new Element('span').update(text);var em=new Element('em',{"class":'x'});span.appendChild(em);a.appendChild(span);li.appendChild(a);Event.observe(em,'click',function(e){this.dispose(e.element().up().up().up());Event.stop(e);}.bind(this));return li;},createMainInput:function(){var li=new Element('li',{width:'100%'});var el=new Element('input',{type:'text'});li.appendChild(el);this.inputTextField=el;return li;},createInput:function(options){var li=new Element('li',{"class":this.options.bitClassName});var el=new Element('input',Object.extend({type:'text',name:this.options.paramName},options||{}));li.appendChild(el);return li;},mainInputFocus:function(){if(this.mainInput==this.current)
return;if(this.current){this.boxBlur();}
this.current=this.mainInput;this.options.onMainInputFocus(this.getMainInput());},mainInputBlur:function(){if(this.current==this.mainInput){this.current=false;this.options.onMainInputBlur(this.getMainInput());}},boxFocus:function(el){if(this.current==el)
return;if(this.current==this.mainInput){this.mainInputBlur();}else if(this.current){this.boxBlur(this.current);}
el.addClassName('bit-focus');this.current=el;this.options.onBoxFocus(el);},boxBlur:function(){if(this.current&&this.mainInput!=this.current)
this.current.className=this.options.bitClassName;this.current=false;this.options.onBoxBlur(this.current);},getPrevious:function(el){if(el.previous().previous()==null)
return el;else
return el.previous().previous();},getNext:function(el){if(el.next()==this.mainInput)
return el;else
return el.next().next();},dispose:function(el,keyCode){var del=null;if(keyCode==null){if(this.current==el)
this.current=false;del=el;}else{if(!this.current)
return;if(this.current!=this.mainInput){del=this.current;this.current=false;}else if(this.getMainInput().value==''){if(this.mainInput.previous()==null)
return;else
el=this.mainInput.previous();}}
this.bits.unset(el.id);this.options.onBoxDispose(el,el.previous().childElements()[0]);if(el.previous()){el.previous().remove();}
el.remove();},disposeAll:function(){this.bits.each(function(pair){this.dispose($(pair.key),null);}.bind(this));this.bits=new Hash();},getMainInput:function(){return this.inputTextField;},getValues:function(){var inputs=$$('input');var values=[];for(var i=0;i<inputs.length;i++){if(inputs[i].type=='text'&&inputs[i].hasClassName('smallInput')){values.push(inputs[i].value);}}
return values;}});var CropDraggable=Class.create(Draggable,{initialize:function(element){this.options=Object.extend({drawMethod:function(){}},arguments[1]||{});this.element=$(element);this.handle=this.element;this.delta=this.currentDelta();this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this);},draw:function(point){var pos=Element.cumulativeOffset(this.element),d=this.currentDelta();pos[0]-=d[0];pos[1]-=d[1];var p=[0,1].map(function(i){return(point[i]-pos[i]-this.offset[i]);}.bind(this));this.options.drawMethod(p);}});var Cropper={};Cropper.Img=Class.create({initialize:function(element,options){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:false,onDragging:Prototype.emptyFunction,onEndCrop:Prototype.emptyFunction,captureKeys:true,onloadCoords:null,maxWidth:0,maxHeight:0,autoIncludeCSS:false},options||{});this.img=$(element);this.clickCoords={x:0,y:0};this.dragging=false;this.resizing=false;this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent);this.isIE=/MSIE/.test(navigator.userAgent);this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent);this.ratioX=0;this.ratioY=0;this.attached=false;this.fixedWidth=(this.options.maxWidth>0&&(this.options.minWidth>=this.options.maxWidth));this.fixedHeight=(this.options.maxHeight>0&&(this.options.minHeight>=this.options.maxHeight));if(typeof this.img=='undefined'){return;}
if(this.options.autoIncludeCSS){$$('script').each(function(s){if(s.src.match(/\/cropper([^\/]*)\.js/)){var path=s.src.replace(/\/cropper([^\/]*)\.js.*/,''),style=document.createElement('link');style.rel='stylesheet';style.type='text/css';style.href=path+'/cropper.css';style.media='screen';document.getElementsByTagName('head')[0].appendChild(style);}});}
if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){var gcd=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/gcd;this.ratioY=this.options.ratioDim.y/gcd;}
this.subInitialize();if(this.img.complete||this.isWebKit){this.onLoad();}else{Event.observe(this.img,'load',this.onLoad.bindAsEventListener(this));}},getGCD:function(a,b){if(b===0){return a;}
return this.getGCD(b,a%b);},onLoad:function(){var cNamePrefix='imgCrop_';var insertPoint=this.img.parentNode;var fixOperaClass='';if(this.isOpera8){fixOperaClass=' opera8';}
this.imgWrap=new Element('div',{'class':cNamePrefix+'wrap'+fixOperaClass});this.north=new Element('div',{'class':cNamePrefix+'overlay '+cNamePrefix+'north'}).insert(new Element('span'));this.east=new Element('div',{'class':cNamePrefix+'overlay '+cNamePrefix+'east'}).insert(new Element('span'));this.south=new Element('div',{'class':cNamePrefix+'overlay '+cNamePrefix+'south'}).insert(new Element('span'));this.west=new Element('div',{'class':cNamePrefix+'overlay '+cNamePrefix+'west'}).insert(new Element('span'));var overlays=[this.north,this.east,this.south,this.west];this.dragArea=new Element('div',{'class':cNamePrefix+'dragArea'});overlays.each(function(o){this.dragArea.insert(o);},this);this.handleN=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleN'});this.handleNE=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleNE'});this.handleE=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleE'});this.handleSE=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleSE'});this.handleS=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleS'});this.handleSW=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleSW'});this.handleW=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleW'});this.handleNW=new Element('div',{'class':cNamePrefix+'handle '+cNamePrefix+'handleNW'});this.selArea=new Element('div',{'class':cNamePrefix+'selArea'});[new Element('div',{'class':cNamePrefix+'marqueeHoriz '+cNamePrefix+'marqueeNorth'}).insert(new Element('span')),new Element('div',{'class':cNamePrefix+'marqueeVert '+cNamePrefix+'marqueeEast'}).insert(new Element('span')),new Element('div',{'class':cNamePrefix+'marqueeHoriz '+cNamePrefix+'marqueeSouth'}).insert(new Element('span')),new Element('div',{'class':cNamePrefix+'marqueeVert '+cNamePrefix+'marqueeWest'}).insert(new Element('span')),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,new Element('div',{'class':cNamePrefix+'clickArea'})].each(function(o){this.selArea.insert(o);},this);this.imgWrap.appendChild(this.img);this.imgWrap.appendChild(this.dragArea);this.dragArea.appendChild(this.selArea);this.dragArea.appendChild(new Element('div',{'class':cNamePrefix+'clickArea'}));insertPoint.appendChild(this.imgWrap);this.startDragBind=this.startDrag.bindAsEventListener(this);Event.observe(this.dragArea,'mousedown',this.startDragBind);this.onDragBind=this.onDrag.bindAsEventListener(this);Event.observe(document,'mousemove',this.onDragBind);this.endCropBind=this.endCrop.bindAsEventListener(this);Event.observe(document,'mouseup',this.endCropBind);this.resizeBind=this.startResize.bindAsEventListener(this);this.handles=[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];this.registerHandles(true);if(this.options.captureKeys){this.keysBind=this.handleKeys.bindAsEventListener(this);Event.observe(document,'keypress',this.keysBind);}
var x=new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)});this.setParams();},registerHandles:function(registration){for(var i=0;i<this.handles.length;i++){var handle=$(this.handles[i]);if(registration){var hideHandle=false;if(this.fixedWidth&&this.fixedHeight){hideHandle=true;}else if(this.fixedWidth||this.fixedHeight){var isCornerHandle=handle.className.match(/([S|N][E|W])$/),isWidthHandle=handle.className.match(/(E|W)$/),isHeightHandle=handle.className.match(/(N|S)$/);if(isCornerHandle||(this.fixedWidth&&isWidthHandle)||(this.fixedHeight&&isHeightHandle)){hideHandle=true;}}
if(hideHandle){handle.hide();}else{Event.observe(handle,'mousedown',this.resizeBind);}}else{handle.show();Event.stopObserving(handle,'mousedown',this.resizeBind);}}},locateImage:function(style){this.img.setStyle({width:style.width,height:style.height,left:'0px',top:'0px'});$(this.imgWrap).setStyle(style);this.setParams();},setParams:function(){this.imgW=this.img.width;this.imgH=this.img.height;$(this.north).setStyle({height:0});$(this.east).setStyle({width:0,height:0});$(this.south).setStyle({height:0});$(this.west).setStyle({width:0,height:0});$(this.imgWrap).setStyle({'width':this.imgW+'px','height':this.imgH+'px'});$(this.selArea).hide();var startCoords={x1:0,y1:0,x2:0,y2:0},validCoordsSet=false;if(this.options.onloadCoords!==null){startCoords=this.cloneCoords(this.options.onloadCoords);validCoordsSet=true;}else if(this.options.ratioDim.x>0&&this.options.ratioDim.y>0){startCoords.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2);startCoords.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2);startCoords.x2=startCoords.x1+this.options.ratioDim.x;startCoords.y2=startCoords.y1+this.options.ratioDim.y;validCoordsSet=true;}
this.setAreaCoords(startCoords,false,false,1);if(this.options.displayOnInit&&validCoordsSet){this.selArea.show();this.drawArea();this.endCrop();}
this.attached=true;},remove:function(){if(this.attached){this.attached=false;this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap);this.imgWrap.parentNode.removeChild(this.imgWrap);Event.stopObserving(this.dragArea,'mousedown',this.startDragBind);Event.stopObserving(document,'mousemove',this.onDragBind);Event.stopObserving(document,'mouseup',this.endCropBind);this.registerHandles(false);if(this.options.captureKeys){Event.stopObserving(document,'keypress',this.keysBind);}}},reset:function(){if(!this.attached){this.onLoad();}else{this.setParams();}
this.endCrop();},handleKeys:function(e){var dir={x:0,y:0};if(!this.dragging){switch(e.keyCode){case(37):dir.x=-1;break;case(38):dir.y=-1;break;case(39):dir.x=1;break;case(40):dir.y=1;break;}
if(dir.x!==0||dir.y!==0){if(e.shiftKey){dir.x*=10;dir.y*=10;}
this.moveArea([this.areaCoords.x1+dir.x,this.areaCoords.y1+dir.y]);this.endCrop();Event.stop(e);}}},calcW:function(){return(this.areaCoords.x2-this.areaCoords.x1);},calcH:function(){return(this.areaCoords.y2-this.areaCoords.y1);},moveArea:function(point){this.setAreaCoords({x1:point[0],y1:point[1],x2:point[0]+this.calcW(),y2:point[1]+this.calcH()},true,false);this.drawArea();this.options.onDragging(this.areaCoords,{width:this.calcW(),height:this.calcH()});},cloneCoords:function(coords){return{x1:coords.x1,y1:coords.y1,x2:coords.x2,y2:coords.y2};},setAreaCoords:function(coords,moving,square,direction,resizeHandle){if(moving){var targW=coords.x2-coords.x1,targH=coords.y2-coords.y1;if(coords.x1<0){coords.x1=0;coords.x2=targW;}
if(coords.y1<0){coords.y1=0;coords.y2=targH;}
if(coords.x2>this.imgW){coords.x2=this.imgW;coords.x1=this.imgW-targW;}
if(coords.y2>this.imgH){coords.y2=this.imgH;coords.y1=this.imgH-targH;}}else{if(coords.x1<0){coords.x1=0;}
if(coords.y1<0){coords.y1=0;}
if(coords.x2>this.imgW){coords.x2=this.imgW;}
if(coords.y2>this.imgH){coords.y2=this.imgH;}
if(direction!==null){if(this.ratioX>0){this.applyRatio(coords,{x:this.ratioX,y:this.ratioY},direction,resizeHandle);}else if(square){this.applyRatio(coords,{x:1,y:1},direction,resizeHandle);}
var mins=[this.options.minWidth,this.options.minHeight],maxs=[this.options.maxWidth,this.options.maxHeight];if(mins[0]>0||mins[1]>0||maxs[0]>0||maxs[1]>0){var coordsTransX={a1:coords.x1,a2:coords.x2},coordsTransY={a1:coords.y1,a2:coords.y2},boundsX={min:0,max:this.imgW},boundsY={min:0,max:this.imgH};if((mins[0]!==0||mins[1]!==0)&&square){if(mins[0]>0){mins[1]=mins[0];}else if(mins[1]>0){mins[0]=mins[1];}}
if((maxs[0]!==0||maxs[0]!==0)&&square){if(maxs[0]>0&&maxs[0]<=maxs[1]){maxs[1]=maxs[0];}else if(maxs[1]>0&&maxs[1]<=maxs[0]){maxs[0]=maxs[1];}}
if(mins[0]>0){this.applyDimRestriction(coordsTransX,mins[0],direction.x,boundsX,'min');}
if(mins[1]>1){this.applyDimRestriction(coordsTransY,mins[1],direction.y,boundsY,'min');}
if(maxs[0]>0){this.applyDimRestriction(coordsTransX,maxs[0],direction.x,boundsX,'max');}
if(maxs[1]>1){this.applyDimRestriction(coordsTransY,maxs[1],direction.y,boundsY,'max');}
coords={x1:coordsTransX.a1,y1:coordsTransY.a1,x2:coordsTransX.a2,y2:coordsTransY.a2};}}}
this.areaCoords=coords;},applyDimRestriction:function(coords,val,direction,bounds,type){var check;if(type=='min'){check=((coords.a2-coords.a1)<val);}
else{check=((coords.a2-coords.a1)>val);}
if(check){if(direction==1){coords.a2=coords.a1+val;}
else{coords.a1=coords.a2-val;}
if(coords.a1<bounds.min){coords.a1=bounds.min;coords.a2=val;}else if(coords.a2>bounds.max){coords.a1=bounds.max-val;coords.a2=bounds.max;}}},applyRatio:function(coords,ratio,direction,resizeHandle){var newCoords;if(resizeHandle=='N'||resizeHandle=='S'){newCoords=this.applyRatioToAxis({a1:coords.y1,b1:coords.x1,a2:coords.y2,b2:coords.x2},{a:ratio.y,b:ratio.x},{a:direction.y,b:direction.x},{min:0,max:this.imgW});coords.x1=newCoords.b1;coords.y1=newCoords.a1;coords.x2=newCoords.b2;coords.y2=newCoords.a2;}else{newCoords=this.applyRatioToAxis({a1:coords.x1,b1:coords.y1,a2:coords.x2,b2:coords.y2},{a:ratio.x,b:ratio.y},{a:direction.x,b:direction.y},{min:0,max:this.imgH});coords.x1=newCoords.a1;coords.y1=newCoords.b1;coords.x2=newCoords.a2;coords.y2=newCoords.b2;}},applyRatioToAxis:function(coords,ratio,direction,bounds){var newCoords=Object.extend(coords,{}),calcDimA=newCoords.a2-newCoords.a1,targDimB=Math.floor(calcDimA*ratio.b/ratio.a),targB=null,targDimA=null,calcDimB=null;if(direction.b==1){targB=newCoords.b1+targDimB;if(targB>bounds.max){targB=bounds.max;calcDimB=targB-newCoords.b1;}
newCoords.b2=targB;}else{targB=newCoords.b2-targDimB;if(targB<bounds.min){targB=bounds.min;calcDimB=targB+newCoords.b2;}
newCoords.b1=targB;}
if(calcDimB!==null){targDimA=Math.floor(calcDimB*ratio.a/ratio.b);if(direction.a==1){newCoords.a2=newCoords.a1+targDimA;}
else{newCoords.a1=newCoords.a1=newCoords.a2-targDimA;}}
return newCoords;},drawArea:function(){var areaWidth=this.calcW(),areaHeight=this.calcH();var px='px',params=[this.areaCoords.x1+px,this.areaCoords.y1+px,areaWidth+px,areaHeight+px,this.areaCoords.x2+px,this.areaCoords.y2+px,(this.img.width-this.areaCoords.x2)+px,(this.img.height-this.areaCoords.y2)+px];var areaStyle=this.selArea.style;areaStyle.left=params[0];areaStyle.top=params[1];areaStyle.width=params[2];areaStyle.height=params[3];var horizHandlePos=Math.ceil((areaWidth-6)/2)+px,vertHandlePos=Math.ceil((areaHeight-6)/2)+px;this.handleN.style.left=horizHandlePos;this.handleE.style.top=vertHandlePos;this.handleS.style.left=horizHandlePos;this.handleW.style.top=vertHandlePos;this.north.style.height=params[1];var eastStyle=this.east.style;eastStyle.top=params[1];eastStyle.height=params[3];eastStyle.left=params[4];eastStyle.width=params[6];var southStyle=this.south.style;southStyle.top=params[5];southStyle.height=params[7];var westStyle=this.west.style;westStyle.top=params[1];westStyle.height=params[3];westStyle.width=params[0];this.subDrawArea();this.forceReRender();},forceReRender:function(){if(this.isIE||this.isWebKit){var n=document.createTextNode(' ');var d,el,fixEL,i;if(this.isIE){fixEl=this.selArea;}
else if(this.isWebKit){fixEl=document.getElementsByClassName('imgCrop_marqueeSouth',this.imgWrap)[0];d=new Element('div');d.style.visibility='hidden';var classList=['SE','S','SW'];for(i=0;i<classList.length;i++){el=document.getElementsByClassName('imgCrop_handle'+classList[i],this.selArea)[0];if(el.childNodes.length){el.removeChild(el.childNodes[0]);}
el.appendChild(d);}}
fixEl.appendChild(n);fixEl.removeChild(n);}},startResize:function(e){this.startCoords=this.cloneCoords(this.areaCoords);this.resizing=true;this.resizeHandle=Event.element(e).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,'');Event.stop(e);},startDrag:function(e){this.selArea.show();this.clickCoords=this.getCurPos(e);this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},false,false,null);this.dragging=true;this.onDrag(e);Event.stop(e);},getCurPos:function(e){var el=this.imgWrap,wrapOffsets=Element.cumulativeOffset(el);while(el.nodeName!='BODY'){wrapOffsets[1]-=el.scrollTop||0;wrapOffsets[0]-=el.scrollLeft||0;el=el.parentNode;}
return{x:Event.pointerX(e)-wrapOffsets[0],y:Event.pointerY(e)-wrapOffsets[1]};},onDrag:function(e){if(this.dragging||this.resizing){var resizeHandle=null,curPos=this.getCurPos(e),newCoords=this.cloneCoords(this.areaCoords),direction={x:1,y:1};if(this.dragging){if(curPos.x<this.clickCoords.x){direction.x=-1;}
if(curPos.y<this.clickCoords.y){direction.y=-1;}
this.transformCoords(curPos.x,this.clickCoords.x,newCoords,'x');this.transformCoords(curPos.y,this.clickCoords.y,newCoords,'y');}else if(this.resizing){resizeHandle=this.resizeHandle;if(resizeHandle.match(/E/)){this.transformCoords(curPos.x,this.startCoords.x1,newCoords,'x');if(curPos.x<this.startCoords.x1){direction.x=-1;}}else if(resizeHandle.match(/W/)){this.transformCoords(curPos.x,this.startCoords.x2,newCoords,'x');if(curPos.x<this.startCoords.x2){direction.x=-1;}}
if(resizeHandle.match(/N/)){this.transformCoords(curPos.y,this.startCoords.y2,newCoords,'y');if(curPos.y<this.startCoords.y2){direction.y=-1;}}else if(resizeHandle.match(/S/)){this.transformCoords(curPos.y,this.startCoords.y1,newCoords,'y');if(curPos.y<this.startCoords.y1){direction.y=-1;}}}
this.setAreaCoords(newCoords,false,e.shiftKey,direction,resizeHandle);this.drawArea();this.options.onDragging(this.areaCoords,{width:this.calcW(),height:this.calcH()});Event.stop(e);}},transformCoords:function(curVal,baseVal,coords,axis){var newVals=[curVal,baseVal];if(curVal>baseVal){newVals.reverse();}
coords[axis+'1']=newVals[0];coords[axis+'2']=newVals[1];},areaCoords:function(){return this.areaCoords;},endCrop:function(){this.dragging=false;this.resizing=false;this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()});},subInitialize:function(){},subDrawArea:function(){}});Cropper.ImgWithPreview=Class.create(Cropper.Img,{subInitialize:function(){this.hasPreviewImg=false;if(typeof(this.options.previewWrap)!='undefined'&&this.options.minWidth>0&&this.options.minHeight>0){this.previewWrap=$(this.options.previewWrap);this.previewImg=this.img.cloneNode(false);this.previewImg.id='imgCrop_'+this.previewImg.id;this.options.displayOnInit=true;this.hasPreviewImg=true;this.previewWrap.addClassName('imgCrop_previewWrap');this.previewWrap.setStyle({width:this.options.minWidth+'px',height:this.options.minHeight+'px'});this.previewWrap.appendChild(this.previewImg);}},subDrawArea:function(){if(this.hasPreviewImg){var calcWidth=this.calcW(),calcHeight=this.calcH();var dimRatio={x:this.imgW/calcWidth,y:this.imgH/calcHeight};var posRatio={x:calcWidth/this.options.minWidth,y:calcHeight/this.options.minHeight};var calcPos={w:Math.ceil(this.options.minWidth*dimRatio.x)+'px',h:Math.ceil(this.options.minHeight*dimRatio.y)+'px',x:'-'+Math.ceil(this.areaCoords.x1/posRatio.x)+'px',y:'-'+Math.ceil(this.areaCoords.y1/posRatio.y)+'px'};var previewStyle=this.previewImg.style;previewStyle.width=calcPos.w;previewStyle.height=calcPos.h;previewStyle.left=calcPos.x;previewStyle.top=calcPos.y;}}});