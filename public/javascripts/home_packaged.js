Iyxzone.Home={version:'1.0',author:['高侠鸿'],Feeder:{},NoticeManager:{}};Object.extend(Iyxzone.Home.NoticeManager,{fetch:function(){new Ajax.Request('notices/first_ten',{method:'get',onSuccess:function(transport){$('my_notices').update(transport.responseText);}.bind(this)});},read:function(noticeID,token){new Ajax.Request('/notices/'+noticeID+'/read',{method:'put',parameters:"authenticity_token="+encodeURIComponent(token),onLoading:function(){Iyxzone.changeCursor('wait');},onSuccess:function(transport){$('my_notices').innerHTML=transport.responseText;Iyxzone.changeCursor('default');}.bind(this)});},readSingle:function(noticeID,token){new Ajax.Request('/notices/'+noticeID+'/read',{method:'put',parameters:"single=1&authenticity_token="+encodeURIComponent(token),onLoading:function(){Iyxzone.changeCursor('wait');},onSuccess:function(transport){Iyxzone.changeCursor('default');$('my_notices').innerHTML=transport.responseText;}.bind(this)});}});Object.extend(Iyxzone.Home.Feeder,{idx:0,type:null,loading:function(div){div.innerHTML="<div style='textAligin: center'><img src='/images/loading.gif'/></div>";},showFeeds:function(type){var feedCategories=$('feed_menu').childElements();for(var i=0;i<feedCategories.length;i++)
feedCategories[i].className='';feedCategories[type].className='hover';this.idx=0;this.type=type;$('feed_list').innerHTML='';this.loading($('more_feed'));new Ajax.Request('/home/feeds?type='+type,{method:'get'});},moreFeeds:function(){new Ajax.Request('/home/more_feeds?type='+this.type+'&idx='+this.idx,{method:'get',onLoading:function(){this.loading($('more_feed'));}.bind(this),onSuccess:function(transport){this.idx++;}.bind(this)});}});Iyxzone.Photo={version:'1.0',author:['高侠鸿'],Tagger:Class.create({}),SlideManager:{},Slide:Class.create({}),Slide2:Class.create({}),Slide3:Class.create({})};Iyxzone.Photo.FriendSelector=Class.create({initialize:function(toggleButton,input,friendList,friendTable,friendItems,gameSelector,token){this.friendID=0;this.toggleButton=$(toggleButton);this.friendList=$(friendList);this.friendTable=$(friendTable);this.friendItems=$(friendItems);this.gameSelector=$(gameSelector);this.token=token;Event.observe(this.toggleButton,'click',function(e){this.toggleFriends();}.bind(this));Event.observe(this.gameSelector,'change',function(){this.getFriends();}.bind(this));this.textboxList=new TextBoxList(input,{onBoxDispose:this.removeBox.bind(this),holderClassName:'friend-select-list s_clear',bitClassName:''});var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;inputs[i].observe('click',this.afterCheckFriend.bindAsEventListener(this));}}
var pinyins=[];var names=[];var ids=[];this.friendItems.childElements().each(function(li){pinyins.push(li.down('input').readAttribute('pinyin'));names.push(li.down('input').readAttribute('login'));ids.push(li.down('input').value);}.bind(this));new Iyxzone.Friend.Autocompleter(this.textboxList.getMainInput(),this.friendList,{ids:ids,names:names,pinyins:pinyins,emptyText:'没有匹配的好友...',tipText:'输入你好友的姓名或者拼音',afterUpdateElement:this.afterSelectFriend.bind(this),comp:this.textboxList.holder});},removeBox:function(el,input){var friendID=input.value;this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}},add:function(info){if(this.textboxList.bits.size()!=0){this.textboxList.disposeAll();}
this.textboxList.add(info.id,info.login);this.friendID=info.id;},getFriends:function(){var gameID=this.gameSelector.value;var friends=this.friendItems.childElements();friends.each(function(f){var info=f.readAttribute('info').evalJSON();var games=info.games;if(gameID=='all'||games.include(gameID)){f.show();}else{f.hide();}}.bind(this));},toggleFriends:function(){if(!this.friendTable.visible()){var pos=this.toggleButton.positionedOffset();this.friendTable.setStyle({position:'absolute',left:(pos.left+this.toggleButton.getWidth()-this.friendTable.getWidth())+'px',top:(pos.top+this.toggleButton.getHeight())+'px'});this.friendTable.show();}else{this.friendTable.hide();}},afterSelectFriend:function(input,selectedLI){var id=selectedLI.readAttribute('id');var login=selectedLI.childElements()[0].innerHTML;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;if(inputs[i].value==id)
inputs[i].checked=true;}}
this.add({id:id,login:login});input.clear();},afterCheckFriend:function(mouseEvent){var checkbox=mouseEvent.target;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i]!=checkbox){inputs[i].checked=false;}}
this.toggleFriends();this.add({id:checkbox.value,login:checkbox.readAttribute('login')});},reset:function(){this.textboxList.getMainInput().clear();this.textboxList.disposeAll();this.friendID=0;var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;}}}});Iyxzone.Photo.Tagger=Class.create({initialize:function(type,photoID,controlPanel,confirmButton,cancelButton,tagInfos,tagsHolder,isCurrentUser,contentInput,toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token,options){this.options=Object.extend({ratio:0.2},options||{});this.type=type;this.photoID=photoID;this.photo=$('photo_'+this.photoID);this.controlPanel=$(controlPanel);this.contentInput=$(contentInput);this.confirmButton=$(confirmButton);this.cancelButton=$(cancelButton);this.tagInfos=new Hash();this.tagsHolder=$(tagsHolder);this.isCurrentUser=isCurrentUser;this.token=token;this.started=false;this.isLoading=true;if(tagInfos.length!=0)
this.tagsHolder.innerHTML='<img src="/images/loading.gif" />';for(var i=0;i<tagInfos.length;i++){this.insertTag(tagInfos[i]);}
this.friendSelector=new Iyxzone.Photo.FriendSelector(toggleButton,friendInput,friendList,friendTable,friendItems,gameSelector,token);Event.observe(this.confirmButton,'click',function(e){Event.stop(e);this.save();}.bind(this));Event.observe(this.cancelButton,'click',function(e){Event.stop(e);this.reset();this.started=false;}.bind(this));this.mousemoveBind=this.showNearestTagWithContent.bindAsEventListener(this);Event.observe(this.photo,'mousemove',this.mousemoveBind);},insertTag:function(tagInfo){this.tagInfos.set(tagInfo.photo_tag.id,{id:tagInfo.photo_tag.id,width:tagInfo.photo_tag.width,height:tagInfo.photo_tag.height,left:tagInfo.photo_tag.x,top:tagInfo.photo_tag.y,content:tagInfo.photo_tag.content,tagged_user_id:tagInfo.photo_tag.tagged_user.id,tagged_user_login:tagInfo.photo_tag.tagged_user.login,poster_id:tagInfo.photo_tag.poster.id,poster_login:tagInfo.photo_tag.poster.login});var li=new Element('li',{id:'tag_'+tagInfo.photo_tag.id});var rectTag=new Element('strong');var posterLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.poster.id}).update(tagInfo.photo_tag.poster.login);var taggedUserLink=new Element('a',{href:'/profiles/'+tagInfo.photo_tag.tagged_user.id}).update(tagInfo.photo_tag.tagged_user.login);rectTag.appendChild(posterLink);rectTag.innerHTML+=('标记了');rectTag.appendChild(taggedUserLink);rectTag.innerHTML+=(' : '+tagInfo.photo_tag.content.escapeHTML());li.appendChild(rectTag);if(this.isLoading){this.tagsHolder.innerHTML='';Element.insert(this.tagsHolder,{bottom:li});this.isLoading=false;}else{Element.insert(this.tagsHolder,{bottom:li});}
Event.observe('tag_'+tagInfo.photo_tag.id,'mouseover',function(e){this.showTagWithContent(tagInfo.photo_tag.id);}.bind(this));Event.observe('tag_'+tagInfo.photo_tag.id,'mouseout',function(e){this.hideTagWithContent(tagInfo.photo_tag.id);}.bind(this));if(this.isCurrentUser){var deleteLink=new Element('a',{href:'javascript: void(0)','class':'icon-active'});var spaceBar=new Element('span');li.appendChild(deleteLink);li.appendChild(spaceBar);deleteLink.observe('click',function(e){facebox.show_confirm_with_callbacks('你确定要删除这个标价吗?',this.remove.bind(this),tagInfo.photo_tag.id);}.bind(this));}},start:function(){if(this.started){return;}
var min=0;if(this.photo.getWidth()<this.photo.getHeight()){min=this.photo.getWidth()*this.options.ratio;}else{min=this.photo.getHeight()*this.options.ratio;}
this.cropImg=new Cropper.Img('photo_'+this.photoID,{onDragging:this.onDragging.bind(this),minWidth:min,minHeight:min,displayOnInit:true,onloadCoords:{x1:this.photo.getWidth()-min,y1:0,x2:this.photo.getWidth(),y2:min}});this.onDragging({x1:this.photo.getWidth()-min,y1:0},{width:min,height:min});Event.stopObserving(this.photo,'mousemove',this.mousemoveBind);this.started=true;},onDragging:function(coords,dimensions){var pos=Element.cumulativeOffset(this.photo);this.controlPanel.setStyle({position:'absolute',left:(pos.left+coords.x1+dimensions.width+2)+'px',top:(pos.top+coords.y1)+'px',zIndex:200});this.controlPanel.show();},validate:function(){if(this.friendSelector.friendID==0){error('你需要选择一个好友');return false;}
return true;},remove:function(tagID){new Ajax.Request('/photo_tags/'+tagID,{method:'delete',parameters:'authenticity_token='+encodeURIComponent(this.token),loading:function(){Iyxzone.changeCursor('wait');},onSuccess:function(transport){if($('square_'+tagID))$('square_'+tagID).remove();if($('content_'+tagID))$('content_'+tagID).remove();$('tag_'+tagID).remove();this.tagInfos.unset(tagID);Iyxzone.changeCursor('default');}.bind(this)});},save:function(){Iyxzone.disableButton(this.confirmButton,'保存中');if(this.validate()){var params="";params=$('tag_form').serialize();params+="&tag[tagged_user_id]="+this.friendSelector.friendID;params+="&tag[x]="+this.cropImg.areaCoords.x1;params+="&tag[y]="+this.cropImg.areaCoords.y1;params+="&tag[width]="+this.cropImg.calcW();params+="&tag[height]="+this.cropImg.calcH();params+="&tag[photo_id]="+this.photoID;params+="&tag[photo_type]="+this.type;new Ajax.Request('/photo_tags',{method:'post',parameters:params,onSuccess:function(transport){this.friendSelector.reset();this.contentInput.clear();var tagInfo=transport.responseText.evalJSON();this.insertTag(tagInfo);Iyxzone.enableButton(this.confirmButton,'保存');}.bind(this)});}else{Iyxzone.enableButotn(this.confirmButotn,'保存');}},showNearestTagWithContent:function(event){var distance=100000000;var tagID=-1;var photoX=this.photo.positionedOffset().left;var photoY=this.photo.positionedOffset().top;var mouseX=event.pointerX();var mouseY=event.pointerY();this.tagInfos.each(function(pair){var x=photoX+pair.value.left;var width=pair.value.width;var y=photoY+pair.value.top;var height=pair.value.height;if(mouseX>=x&&mouseX<=x+width&&mouseY>=y&&mouseY<=y+height){var deltaX=(x+width/2)-mouseX;var deltaY=(y+height/2)-mouseY;var delta=((x+width/2)-mouseX)*((x+width/2)-mouseX)+((y+height/2)-mouseY)*((y+height/2)-mouseY);if(delta<distance){distance=delta;tagID=pair.key;}}else{if(pair.key==this.currentTagID){this.hideTagWithContent(this.currentTagID);this.currentTagID=-1;}}}.bind(this));if(tagID>=0){this.currentTagID=tagID;this.showTagWithContent(tagID);}},hideTagWithContent:function(tagID){var square=$('square_'+tagID);var info=$('tag_content_'+tagID);if(square)square.hide();if(info)info.hide();},showTagWithContent:function(tagID){var tag=this.tagInfos.get(tagID);var pos=this.photo.positionedOffset();var x=tag.left;var y=tag.top;var width=tag.width;var height=tag.height;var square=$('square_'+tagID);if(!square){square=new Element('div',{className:'square-class',id:'square_'+tagID});document.body.appendChild(square);}
square.setStyle({'position':'absolute','width':width+'px','height':height+'px','left':(x+pos.left)+'px','top':(y+pos.top)+'px','border':'2px solid #eeeeee','display':'block','zIndex':4});var info=$('tag_content_'+tagID);if(!info){info=new Element('div',{id:'tag_content_'+tagID}).update(tag.content);document.body.appendChild(info);}
info.setStyle({'position':'absolute','color':'white','background':'black','left':(x+width+pos.left)+'px','top':(y+pos.top)+'px','display':'block','zIndex':4});},reset:function(){this.cropImg.remove();this.controlPanel.hide();Event.observe(this.photo,'mousemove',this.mousemoveBind);}});Iyxzone.Photo.Slide=Class.create({initialize:function(photoType,currentID,ids,urls,frames,downBtn,upBtn){this.photo=$('photo_'+currentID);this.photoType=photoType+'s';this.downBtn=downBtn;this.upBtn=upBtn;this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.blankImage=new Image();this.blankImage.src='/images/photo/nopic50x50.png';this.photo.observe('mousemove',this.mouseOnPhoto.bind(this));this.photo.observe('click',this.clickOnPhoto.bind(this));this.photo.observe('mouseoff',this.mouseOffPhoto.bind(this));this.urls=urls;this.ids=ids;this.currentID=currentID;this.idPos=0;this.mappings=new Hash();this.frames=frames;this.upTimer=null;this.downTimer=null;for(var i=0;i<this.ids.length;i++){if(this.ids[i]==this.currentID){this.idPos=i;break;}}
var pos=Math.floor(frames.length/2);for(var i=0;i<this.frames.length;i++){var p=(this.idPos+i-pos);if(p>=0&&p<this.ids.length){this.loadImage(i,p);}else{this.setBlank(i);}}
this.setBtnEvents();this.changeBtn();},getSide:function(event){var mouseX=event.pointerX();var photoLeft=this.photo.positionedOffset().left;var photoWidth=this.photo.width;var delta=mouseX-photoLeft;if(delta<photoWidth/2){return'left';}else if(delta>photoWidth/2&&delta<photoWidth){return'right';}
return-1;},mouseOnPhoto:function(event){var side=this.getSide(event);if(side=='left'){this.photo.writeAttribute('style',"cursor:url(/images/skin/left.cur), auto;");}else if(side=='right'){this.photo.writeAttribute('style',"cursor:url(/images/skin/right.cur), auto;");}},mouseOffPhoto:function(event){Iyxzone.changeCursor('default');},clickOnPhoto:function(event){var side=this.getSide(event);if(side=='left'){var idPos=(this.idPos-1+this.ids.length)%this.ids.length;}else if(side=='right'){var idPos=(this.idPos+1)%this.ids.length;}
window.location.href="/"+this.photoType+"/"+this.ids[idPos];},setBtnEvents:function(){this.downBtn.observe('click',this.scrollDown.bindAsEventListener(this));this.upBtn.observe('click',this.scrollUp.bindAsEventListener(this));},changeBtn:function(){if(this.idPos==0){this.downBtn.className='btn downbtn-gray';}else{this.downBtn.className='btn downbtn';}
if(this.idPos==this.ids.length-1){this.upBtn.className='btn upbtn-gray';}else{this.upBtn.className='btn upbtn';}},setBlank:function(idx){this.frames[idx].innerHTML="<a href='#'><img src='"+this.blankImage.src+"' class='imgbox01'/></a>";},loadImage:function(idx,photoIdx){this.frames[idx].innerHTML="<img src='"+this.loadingImage.src+"'/>";var img=this.mappings.get(this.ids[photoIdx]);if(!img){img=new Image();img.src=this.urls[photoIdx];this.mappings.set(this.ids[photoIdx],img);}
if(this.currentID==this.ids[photoIdx]){this.frames[idx].addClassName('now');}
this.frames[idx].innerHTML="<a href='/"+this.photoType+"/"+this.ids[photoIdx]+"'><img src='"+img.src+"' class='imgbox01' width='50px' height='50px'/></a>";},scrollDown:function(){if(this.idPos==0||this.downTimer!=null){return;}
var div=this.frames[0].up();new Effect.Morph(div,{style:'top: 0px',duration:0.5});this.downTimer=setTimeout(this.afterScrollDown.bind(this),550);this.idPos--;this.changeBtn();},afterScrollDown:function(){var frame=new Element('div',{'class':'img'});Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();var p=this.idPos-Math.floor((this.frames.length-1)/2);if(p>=0){this.loadImage(0,p);}else{this.setBlank(0);}
frame.up().setStyle({'top':'-67px'});var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);this.downTimer=null;},scrollUp:function(){if(this.idPos==this.ids.length-1||this.upTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'top: -134px',duration:0.5});this.upTimer=setTimeout(this.afterScrollUp.bind(this),550);this.idPos++;this.changeBtn();},afterScrollUp:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({'top':'-67px'});var frame=new Element('div',{'class':'img'});Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();var p=this.idPos+this.frames.length-2-Math.floor((this.frames.length-3)/2);if(p<this.ids.length){this.loadImage(this.frames.length-1,p);}else{this.setBlank(this.frames.length-1);}
this.upTimer=null;}});Iyxzone.Photo.Slide2=Class.create({initialize:function(photoType,ids,urls,frames,leftBtn,rightBtn){this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.photoType=photoType+'s';this.ids=ids;this.urls=urls;this.frames=frames;this.leftBtn=leftBtn;this.rightBtn=rightBtn;this.idPos=1;for(var i=0;i<frames.length;i++){if(i>=0&&i<ids.length)
this.load(i,i);}
this.rightBtn.observe('click',this.scrollRight.bindAsEventListener(this));this.leftBtn.observe('click',this.scrollLeft.bindAsEventListener(this));},load:function(idx,photoIdx){if(photoIdx<0){photoIdx=(photoIdx+this.ids.length)%this.ids.length;}else if(photoIdx>=this.ids.length){photoIdx=(photoIdx)%this.ids.length;}
this.frames[idx].innerHTML='<img src="'+this.loadingImage.src+'" class="imgbox01"/>';this.frames[idx].innerHTML='<img src="'+this.urls[photoIdx]+'" class="imgbox01"/>';this.frames[idx].writeAttribute('href','/'+this.photoType+'/'+this.ids[photoIdx]);},scrollRight:function(){if(this.rightTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: 0px',duration:0.5});this.rightTimer=setTimeout(this.afterScrollRight.bind(this),550);this.idPos=(this.idPos-1+this.ids.length)%this.ids.length;},afterScrollRight:function(){var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);var frame=new Element('a');Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();this.load(0,this.idPos-1);frame.up().setStyle({left:'-136px'});this.rightTimer=null;},scrollLeft:function(){if(this.leftTimer!=null)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'left: -272px',duration:0.5});this.leftTimer=setTimeout(this.afterScrollLeft.bind(this),550);this.idPos=(this.idPos+1)%this.ids.length;},afterScrollLeft:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({left:'-136px'});var frame=new Element('a');Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();this.load(this.frames.length-1,this.idPos+this.frames.length);this.leftTimer=null;}});Iyxzone.Photo.Slide3=Class.create({initialize:function(currentID,photoInfos,frames,downBtn,upBtn){this.downBtn=downBtn;this.upBtn=upBtn;this.loadingImage=new Image();this.loadingImage.src='/images/loading.gif';this.blankImage=new Image();this.blankImage.src='/images/photo/nopic50x50.png';this.urls=[];this.thumbnails=[];this.ids=[];this.notations=[];this.widths=[];this.heights=[];this.currentID=currentID;this.mappings=new Hash();this.thumbnailMappings=new Hash();this.frames=frames;for(var i=0;i<photoInfos.length;i++){var info=photoInfos[i];this.ids.push(info.id);this.urls.push(info.url);this.thumbnails.push(info.thumbnail_url);this.notations.push(info.notation);this.widths.push(info.width);this.heights.push(info.height);}
this.upOffset=0;this.downOffset=0;this.idPos=0;for(var i=0;i<this.ids.length;i++){if(this.ids[i]==this.currentID){this.idPos=i;break;}}
var pos=Math.floor(frames.length/2);this.frames[pos].addClassName('now');for(var i=0;i<this.frames.length;i++){var p=(this.idPos+i-pos);if(p>=0&&p<this.ids.length){this.loadImage(i,p);}else{this.setBlank(i);}}
this.updatePhotoInfo(this.idPos);this.setBtnEvents();this.changeBtn();},getSide:function(event){var mouseX=event.pointerX();var photoLeft=this.photo.positionedOffset().left;var photoWidth=this.photo.width;var delta=mouseX-photoLeft;if(delta<photoWidth/2){return'left';}else if(delta>photoWidth/2&&delta<photoWidth){return'right';}
return-1;},mouseOnPhoto:function(event){var side=this.getSide(event);if(side=='left'){this.photo.writeAttribute('style',"cursor:url(/images/skin/left.cur), auto;");}else if(side=='right'){this.photo.writeAttribute('style',"cursor:url(/images/skin/right.cur), auto;");}},mouseOffPhoto:function(event){Iyxzone.changeCursor('default');},clickOnPhoto:function(event){var side=this.getSide(event);var pos=Math.floor(this.frames.length/2);if(side=='left'){if(this.idPos==0){}else{this.scrollDown(1);}}else if(side=='right'){if(this.idPos==this.ids.length-1){}else{this.scrollUp(1);}}},setBtnEvents:function(){this.downBtn.observe('click',function(event){this.scrollDown(1);}.bind(this));this.upBtn.observe('click',function(event){this.scrollUp(1);}.bind(this));},changeBtn:function(){if(this.idPos==0){this.downBtn.className='btn downbtn-gray';}else{this.downBtn.className='btn downbtn';}
if(this.idPos==this.ids.length-1){this.upBtn.className='btn upbtn-gray';}else{this.upBtn.className='btn upbtn';}},setBlank:function(idx){this.frames[idx].innerHTML="<a href='javascript:void(0)'><img src='"+this.blankImage.src+"' class='imgbox01'/></a>";},cacheThumbnail:function(idx){var img=this.thumbnailMappings.get(this.ids[idx]);if(!img){img=new Image();img.src=this.thumbnails[idx];this.thumbnailMappings.set(this.ids[idx],img);}},getThumbnailElement:function(idx){var url=this.thumbnails[idx];this.cacheThumbnail(url);var img=new Element('img',{'src':url});img.setStyle({'width':'50px','height':'50px'});img.addClassName('imgbox01');return img;},cacheImage:function(idx){var img=this.mappings.get(this.ids[idx]);if(!img){img=new Image();img.src=this.urls[idx];this.mappings.set(this.ids[idx],img);}},getImageElement:function(idx){var url=this.urls[idx];this.cacheImage(idx);var el=new Element('img',{src:url});var width=this.widths[idx];var height=this.heights[idx];if(width<500){el.setStyle({"width":width,"height":height});}else{width=500;height=height*500/width;el.setStyle({"width":width,"height":height});}
return el;},updatePhotoInfo:function(index){var img=this.getImageElement(index);$('picture').update('');$('picture').appendChild(img);if(this.notations[index]&&this.notations[index]!='')
$('notation').update(this.notations[index].escapeHTML().gsub('\n','<br/>'));this.photo=$('picture').childElements()[0];this.photo.observe('mousemove',this.mouseOnPhoto.bind(this));this.photo.observe('click',this.clickOnPhoto.bind(this));this.photo.observe('mouseoff',this.mouseOffPhoto.bind(this));},scrollUp:function(offset){if(this.downOffset!=0||this.upOffset!=0||this.idPos==this.ids.length-1){return;}
var pos=Math.floor(this.frames.length/2);this.frames[pos].writeAttribute('class','img');this.upOffset=offset;this.frames[pos+offset].addClassName('now');this.updatePhotoInfo(this.idPos+offset);this.startScrollUp();},scrollDown:function(offset){if(this.downOffset!=0||this.upOffset!=0||this.idPos==0){return;}
var pos=Math.floor(this.frames.length/2);this.frames[pos].writeAttribute('class','img');this.downOffset=offset;this.frames[pos-offset].addClassName('now');this.updatePhotoInfo(this.idPos-offset);this.startScrollDown();},loadImage:function(idx,photoIdx){this.frames[idx].innerHTML="<img src='"+this.loadingImage.src+"'/>";var img=this.getThumbnailElement(photoIdx);var a=new Element('a',{href:'javascript:void(0)',index:photoIdx});a.appendChild(img);this.frames[idx].update(a);a.observe('click',function(e){var index=parseInt(e.target.up('a').readAttribute('index'));var idPos=this.idPos;if(index==idPos){}else if(index<idPos){this.scrollDown(idPos-index);}else if(index>idPos){this.scrollUp(index-idPos);}}.bind(this));},startScrollDown:function(){if(this.idPos==0){return;}
var div=this.frames[0].up();new Effect.Morph(div,{style:'top: 0px',duration:0.5,afterFinish:this.afterScrollDown.bind(this)});this.idPos=this.idPos-1;this.changeBtn();},afterScrollDown:function(){var frame=new Element('div',{'class':'img'});Element.insert(this.frames[0],{before:frame});this.frames=frame.up().childElements();var p=this.idPos-Math.floor((this.frames.length-1)/2);if(p>=0){this.loadImage(0,p);}else{this.setBlank(0);}
frame.up().setStyle({'top':'-67px'});var len=this.frames.length;this.frames[len-1].remove();this.frames.splice(len-1,1);this.downOffset--;if(this.downOffset!=0){this.startScrollDown();}},startScrollUp:function(){if(this.idPos==this.ids.length-1)
return;var div=this.frames[0].up();new Effect.Morph(div,{style:'top: -134px',duration:0.5,afterFinish:this.afterScrollUp.bind(this)});this.idPos++;this.changeBtn();},afterScrollUp:function(){this.frames[0].remove();this.frames.splice(0,1);this.frames[0].up().setStyle({'top':'-67px'});var frame=new Element('div',{'class':'img'});Element.insert(this.frames[this.frames.length-1],{after:frame});this.frames=frame.up().childElements();var p=this.idPos+this.frames.length-2-Math.floor((this.frames.length-3)/2);if(p<this.ids.length){this.loadImage(this.frames.length-1,p);}else{this.setBlank(this.frames.length-1);}
this.upOffset--;if(this.upOffset!=0){this.startScrollUp();}}});Iyxzone.Video={version:'1.0',author:['高侠鸿'],Builder:{},play:function(videoID,videoLink){$('video_'+videoID).update(videoLink);}};Object.extend(Iyxzone.Video.Builder,{tagBuilder:null,validate:function(){if($('video_title').value==''){error('标题不能为空');return false;}
if($('video_video_url').value==''){error('url不能为空');return false;}
if($('video_game_id').value==''){error('游戏类别不能为空');return false;}
if($('video_title').length>=100){facebox.show_error('标题太长了，最长100个字符');return false;}
return true;},prepare:function(form){var newTags=this.tagBuilder.getNewTags();var delTags=this.tagBuilder.getDelTags();for(var i=0;i<newTags.length;i++){var el=new Element("input",{type:'hidden',value:newTags[i],id:'video[new_friend_tags][]',name:'video[new_friend_tags][]'});form.appendChild(el);}
for(var i=0;i<delTags.length;i++){var el=new Element("input",{type:'hidden',value:delTags[i],id:'video[del_friend_tags][]',name:'video[del_friend_tags][]'});form.appendChild(el);}},save:function(button,form){Iyxzone.disableButtonThree(button,'发布中..');if(this.validate()){this.prepare(form);form.submit();}else{Iyxzone.enableButtonThree(button,'保存');}},update:function(button,form){Iyxzone.disableButtonThree(button,'更新中..');if(this.validate()){this.prepare(form);form.submit();}else{Iyxzone.enableButtonThree(button,'更新');}},init:function(max,tagInfos,toggleButton,input,friendList,friendTable,friendItems,gameSelector,confirmButton,cancelButton){this.tagBuilder=new Iyxzone.Friend.Tagger(max,tagInfos,toggleButton,input,friendList,friendTable,friendItems,gameSelector,confirmButton,cancelButton);}});Iyxzone.Friend={version:'1.0',author:['高侠鸿'],Suggestor:{},Tagger:Class.create({})};Iyxzone.Comrade={version:'1.0',author:['高侠鸿'],Suggestor:{}};Object.extend(Iyxzone.Friend.Suggestor,{newSuggestion:function(suggestionID,token,nicerLayout){var url='/friend_suggestions/new';var exceptIDs=[];var suggestions=$('friend_suggestions').childElements();for(var i=0;i<suggestions.length;i++){exceptIDs.push(suggestions[i].readAttribute('suggestion_id'));}
var exceptParam="";for(var i=0;i<exceptIDs.length;i++){exceptParam+="except_ids[]="+exceptIDs[i]+"&";}
url+="?"+exceptParam;new Ajax.Request(url,{method:'get',parameters:{sid:suggestionID,authenticity_token:encodeURIComponent(token),nicer:nicerLayout},onSuccess:function(transport){var card=$('friend_suggestion_'+suggestionID);var temp_parent=new Element('div');temp_parent.update(transport.responseText);var li=temp_parent.childElements()[0];li.setStyle({'opacity':0});Element.replace(card,li);new Effect.Opacity(li,{from:0,to:1})}.bind(this)});}});Object.extend(Iyxzone.Comrade.Suggestor,{newSuggestion:function(serverID,suggestionID,token){var url='friend_suggestions/new';var exceptIDs=[];var suggestions=$('server_'+serverID+'_suggestions').childElements();for(var i=0;i<suggestions.length;i++){exceptIDs.push(suggestions[i].readAttribute('suggestion_id'));}
var exceptParam="";for(var i=0;i<exceptIDs.length;i++){exceptParam+="except_ids[]="+exceptIDs[i]+"&";}
url+="?"+exceptParam;new Ajax.Request(url,{method:'get',parameters:{sid:suggestionID,server_id:serverID,authenticity_token:encodeURIComponent(token)},onSuccess:function(transport){var card=$('comrade_suggestion_'+suggestionID);var temp_parent=new Element('div');temp_parent.update(transport.responseText);var li=temp_parent.childElements()[0];li.setStyle({'opacity':0});Element.replace(card,li);new Effect.Opacity(li,{from:0,to:1})}.bind(this)});}});Iyxzone.Friend.Autocompleter=Class.create(Autocompleter.Local,{initialize:function($super,element,update,options){options=Object.extend({selector:function(instance){var options=instance.options;var pinyins=options.pinyins;var names=options.names;var ids=options.ids;var token=instance.getToken();var ret=[];for(var i=0;i<pinyins.length;i++){var pinyinPos=options.ignoreCase?pinyins[i].toLowerCase().indexOf(token.toLowerCase()):pinyins[i].indexOf(token);var namePos=options.ignoreCase?names[i].toLowerCase().indexOf(token.toLowerCase()):names[i].indexOf(token);if(pinyinPos>=0||namePos>=0){ret.push('<li style="list-style-type:none;" id='+ids[i]+' ><a href="javascript:void(0)">'+names[i]+'</a></li>');}}
if(ret.length==0){return options.emptyText;}else{return"<ul>"+ret.join('')+"</ul>";}}},options||{});Event.observe(element,'focus',this.showTip.bindAsEventListener(this));$super(element,update,null,options);},showTip:function(){this.update.update(this.options.tipText);var comp=this.options.comp;this.update.setStyle({position:'absolute',left:comp.positionedOffset().left+'px',top:(comp.positionedOffset().top+comp.getHeight())+'px',width:(comp.getWidth()-10)+'px',maxHeight:'200px',overflowX:'hidden',overflowY:'auto',padding:'5px',background:'white',border:'1px solid #E7F0E0'});this.update.show();},onClick:function($super,event){Event.stop(event);$super(event);},updateChoices:function($super,data){if(data.indexOf('ul')<0){this.update.update(data);this.update.show();}else{$super(data);}
var comp=this.options.comp;this.update.setStyle({position:'absolute',left:comp.positionedOffset().left+'px',top:(comp.positionedOffset().top+comp.getHeight())+'px',width:(comp.getWidth()-10)+'px',maxHeight:'200px',overflowX:'hidden',autoflowY:'auto',padding:'5px',background:'white',border:'1px solid #E7F0E0'});}});Iyxzone.Friend.Tagger=Class.create({initialize:function(max,tagInfos,toggleButton,input,friendList,friendTable,friendItems,gameSelector,confirmButton,cancelButton){this.max=max;this.tags=new Hash();this.newTags=new Hash();this.delTags=new Array();this.toggleButton=$(toggleButton);this.friendList=$(friendList);this.friendTable=$(friendTable);this.friendItems=$(friendItems);this.confirmButton=$(confirmButton);this.cancelButton=$(cancelButton);this.gameSelector=$(gameSelector);this.taggedUserList=new TextBoxList(input,{onBoxDispose:this.removeBox.bind(this),holderClassName:'friend-select-list s_clear',bitClassName:''});for(var i=0;i<tagInfos.length;i++){var info=tagInfos[i];var el=this.taggedUserList.add(info.friend_id,info.friend_name);this.tags.set(info.friend_id,el);}
var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'){inputs[i].checked=false;inputs[i].observe('click',this.afterCheckFriend.bindAsEventListener(this));if(this.tags.keys().include(inputs[i].value)){inputs[i].checked=true;}}}
Event.observe(this.toggleButton,'click',function(e){this.toggleFriends();Event.stop(e);}.bind(this),false);Event.observe(this.confirmButton,'click',function(event){Event.stop(event);var checked=new Hash();var delTags=new Array();var newTags=new Array();var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].checked){checked.set(inputs[i].value,{id:inputs[i].value,login:inputs[i].readAttribute('login')});}}
this.tags.keys().each(function(key){if(!checked.keys().include(key)){delTags.push(key);}}.bind(this));this.newTags.keys().each(function(key){if(!checked.keys().include(key)){delTags.push(key);}}.bind(this));this.removeTags(delTags);var tagIDs=this.tags.keys();var newTagIDs=this.newTags.keys();checked.each(function(pair){var input=pair.value;var key=pair.key;if(!tagIDs.include(key)&&!newTagIDs.include(key)){newTags.push(input);}}.bind(this));alert("new: "+newTags);this.addTags(newTags);this.toggleFriends();}.bind(this));Event.observe(this.cancelButton,'click',function(event){Event.stop(event);this.toggleFriends();}.bind(this),false);Event.observe(this.gameSelector,'change',function(e){this.getFriends(this.gameSelector.value);Event.stop(e);}.bind(this),false);var pinyins=[];var names=[];var ids=[];this.friendItems.childElements().each(function(li){pinyins.push(li.down('input').readAttribute('pinyin'));names.push(li.down('input').readAttribute('login'));ids.push(li.down('input').value);}.bind(this));new Iyxzone.Friend.Autocompleter(this.taggedUserList.getMainInput(),this.friendList,{ids:ids,names:names,pinyins:pinyins,afterUpdateElement:this.afterSelectFriend.bind(this),tipText:'输入你好友的名字或者拼音',emptyText:'没有匹配的好友...',comp:this.taggedUserList.holder});},removeBox:function(el,input){var friendID=input.value;var tagInfo=this.tags.unset(friendID);if(tagInfo){this.delTags.push(friendID);}else{this.newTags.unset(friendID);}
var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].value==friendID){inputs[i].checked=false;}}},removeTags:function(friendIDs){for(var i=0;i<friendIDs.length;i++){var friendID=friendIDs[i];var tagInfo=this.tags.unset(friendID);if(tagInfo){this.delTags.push(friendID);tagInfo.remove();}else{var div=this.newTags.unset(friendID);div.remove();}}},addTags:function(friends){for(var i=0;i<friends.length;i++){var el=this.taggedUserList.add(friends[i].id,friends[i].login);this.newTags.set(friends[i].id,el);}},getNewTags:function(){return this.newTags.keys();},getDelTags:function(){return this.delTags;},getFriends:function(game_id){var friends=this.friendItems.childElements();friends.each(function(f){var info=f.readAttribute('info').evalJSON();var games=info.games;if(game_id=='all'||games.include(game_id)){f.show();}else{f.hide();}}.bind(this));},toggleFriends:function(){if(!this.friendTable.visible()){var pos=this.toggleButton.positionedOffset();this.friendTable.setStyle({position:'absolute',left:(pos.left+this.toggleButton.getWidth()-this.friendTable.getWidth())+'px',top:(pos.top+this.toggleButton.getHeight())+'px'});this.friendTable.show();}else{this.friendTable.hide();}},afterSelectFriend:function(input,selectedLI){var id=selectedLI.readAttribute('id');var login=selectedLI.childElements()[0].innerHTML;input.clear();if(this.tags.keys().include(id)||this.newTags.keys().include(id)){return;}else{if(this.tags.keys().length+this.newTags.keys().length>=this.max){error('最多选'+this.max+'个!');return;}
this.addTags([{id:id,login:login}]);input.clear();var inputs=$$('input');for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].value==id){inputs[i].checked=true;}}}},afterCheckFriend:function(mouseEvent){var checkbox=mouseEvent.target;if(!checkbox.checked){return;}
var inputs=$$('input');var checked=0;for(var i=0;i<inputs.length;i++){if(inputs[i].type=='checkbox'&&inputs[i].checked)
checked++;}
if(checked>this.max){error('最多选'+this.max+'个!');checkbox.checked=false;return;}},reset:function(tagInfos){this.newTags.each(function(pair){this.tags.set(pair.key,pair.value);}.bind(this));this.delTags=new Array();this.newTags=new Hash();}});Iyxzone.Status={version:'1.0',author:['高侠鸿'],Builder:{}};Object.extend(Iyxzone.Status.Builder,{validate:function(){if($('status_content').value==''){error('状态不能为空');return false;}else if($('status_content').value.length>140){error('字数不能超过140');return false;}
return true;},save:function(button,form){Iyxzone.disableButtonThree(button,'发布中..');if(this.validate()){new Ajax.Request('/statuses',{method:'post',parameters:$(form).serialize(),onComplete:function(){Iyxzone.enableButtonThree(button,'发布');if($('words_count')){$('words_count').innerHTML='0/140';}}});}else{Iyxzone.enableButtonThree(button,'发布');}}});