require 'json'

class Contacts

  class Netease < Base

    URL         = "http://mail.163.com/"
    LOGIN_URL   = "http://reg.163.com/login.jsp?type=1&url=http://entry.mail.163.com/coremail/fcg/ntesdoor2?" + CGI.escape("lightweight%3D1%26verifycookie%3D1%26language%3D-1%26style%3D-1")

#login.jsp?type=1&product=mail163&url=http://entry.mail.163.com/coremail/fcg/ntesdoor2?lightweight%3D1%26verifycookie%3D1%26language%3D-1%26style%3D-1"
    
    def real_connect
      postdata = "type=1&url=#{CGI.escape("http://entry.mail.163.com/coremail/fcg/ntesdoor2?lightweight%3D1%26verifycookie%3D1%26language%3D-1%26style%3D-1")}" + "verifycookie=1&style=1&product=mail163&savelogin=&url2=#{CGI.escape("http%3A%2F%2Fmail.163.com%2Ferrorpage%2Ferr_163.htm")}&username=smdaiych&password=dyctest&selType=js35"
      puts "-------------------------------------------"
      puts LOGIN_URL
      puts "dycpostdata:\t" + postdata
      #initcookie = ""
      data, resp, cookies, forward = post(LOGIN_URL, postdata, "", "mail.163.com")
      #puts "forward:\t#{forward}" 
      #puts "code: #{resp.code}"
      #puts ""
      puts "cookie: #{cookies}"
      puts "response: #{resp}"
      puts ""
      
      puts "forward: #{forward}"
     
      data, resp, cookies, forward = get(forward, cookies, LOGIN_URL) 
      #puts "code: #{resp.code}"
      #puts "" 
      #puts cookies
      #puts ""
      puts "forward: #{forward}"
   
      data, resp, cookies, forward = get(forward, cookies, forward)
      #puts "code: #{resp.code}"
      #puts ""
      #puts cookies
      #puts ""
      p1 = resp.body.index('contacts:')
      p2 = resp.body.index('groups:', p1)
      contacts_str = resp.body[(p1+9)..(p2-5)]
      contacts_str.gsub!("&quot;", '"')
      JSON.parse(contacts_str)
      puts resp.body
      puts "contacts: #{contacts_str}"
      
=begin 
      http = open_http(URI.parse(forward))
      resp, data = http.post("/classic/addr_member.php", "sort_item=letter&sort_type=desc&act=list&gid=6", {"Cookie" => cookies})
      puts "code: #{resp.code}"
      puts "body: #{resp.body}"
=end
    end

    def contacts
    end

  private
  
  end  
  
  TYPES[:yahoo] = Yahoo

end 
