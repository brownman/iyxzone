<% content_for :javascript_include do %>
<%= javascript_include_tag 'poll' %>
<% end %>

<% content_for :html_title, "#{@user.login}的投票 - 17Gaming.com" %>
<% content_for :html_description, "#{@user.login}的投票 - 17Gaming.com (一起游戏网)愿做网络游戏玩家的精神家园。" %>
<% content_for :html_keywords, "#{current_user.login}, 游戏活动, 17Gaming, 一起游戏, 一起游戏网, 网络游戏玩家, 游戏社区, 社交网站, 网络游戏社区" %>

<div id="canvas" class="round_r_t"><div class="round_l_t"><div class="round_r_b"><div class="round_l_b">
  <div class="round_m"><div class="round_body">
	<% if @user==current_user %>
    <h1 class="app-vote">投票</h1>
	<% else %>
    <div class="friend-head space s_clear">
      <span class="left"><%= avatar @user, :class=>"imgbox01"%></span>
      <p class="left">
        <strong><%= @user.login %>的投票</strong><br />
        <%= link_to '个人主页', profile_url(@user.profile), :class=>'red'%>
      </p>
    </div>
	<% end %>
    <div class="box02 canvas_int">
      <div class="tab tab01">
        <div class="right"><%= link_to "新投票", new_poll_url %></a></div>
        <ul>
          <li><span><%= link_to "热门投票", hot_polls_url(:uid => @user.id) %></span></li>
          <li class='hover'><span><%= link_to "#{get_subject @user}的投票", polls_url(:uid => @user.id) %></span></li>
          <% if @user == current_user %>
          <li><span><%= link_to "朋友的投票", friends_polls_url(:uid => @user.id) %></span></li>
					<% end %>
        </ul>
      </div>
      <div class="vote-box">
          <% if !@poll.past and @user == current_user %>
          <div class="vote-op left">
            <span class="vote-op-add"></span><%= link_to '增加侯选项', new_poll_answer_url(@poll), :rel => 'facebox' %>
            <% unless @poll.no_deadline %>
            <span class='vote-op-time'></span><%= link_to '修改截至时间', edit_poll_url(@poll, :type => 0), :rel => 'facebox' %>
            <% end %>
						<span class='vote-op-edit'></span><%= link_to '修改选项说明', edit_poll_url(@poll, :type => 1), :rel => 'facebox' %>
            <span class="vote-op-invite"></span><%= link_to '邀请更多人', new_poll_invitation_url(@poll) %>
            <span class="vote-op-del"></span><%= facebox_confirm '删除本投票', poll_url(@poll), {:msg => '你确定要删除该投票吗?', :method => :delete} %></li>
          </div>
          <% else %>
          <div class='path-box'>
            <label><%= link_to "#{@user.login}的投票", polls_url(:uid => @user.id) %></label>
            <span>投票</span>
          </div>
          <% end %>
					<div class="vote-state right">
						<div class="vote-icon left">
						<h5><%= @poll.voters_count %>人</h5>
						<p>参与投票</p>
						</div>
            <%= facebox_link '分享', new_sharing_url(:shareable_type => 'Poll', :shareable_id => @poll.id), :class => "left love-btn" %>
					</div>
					<div class='rows'></div>
          <table class="vote-header-table" cellpadding="0">
            <tr>
              <td class="vote-content" align='center'>
                <h5><%= @poll.name %> 
                  <span>（限选<%= @poll.max_multiple %>项）<span><%= time_ago_in_chinese @poll.created_at %></span></span>
                </h5>
								<p>关于<%= @poll.game.name%></p>
                <p><%= simple_format @poll.description %></p>
              </td>
            </tr>
          </table>
          <% form_tag poll_votes_url(@poll), :onsubmit=> "Iyxzone.disableButton($(poll_vote_submit_btn),'请等待..');" do %>
          <table class="vote-status-table" cellpadding="0">
            <% @poll.answers.each_with_index do |answer, i| %>
            <tr>
              <td class="title"><%= answer.description %>：</td>
              <%= generate_percentage_bar answer, @poll %>
              <td class="cb">
                <% if !@poll.past and !@vote and @poll.is_votable_by? current_user %>
                  <%= check_box_tag "votes[]", answer.id, false, :onclick => "Iyxzone.Poll.checkMultipleSelection(#{@poll.max_multiple}, this);"%>
                <% elsif @vote %>
                  <%= check_box_tag "votes[]", answer.id, @vote.answer_ids.include?(answer.id), :disabled => true %>
                <% end %>
              </td>
              <td class="btn">
              <% if i == 0 %>
                <% if @poll.past %>
                  已经过期了
                <% elsif @vote %>
                  你已经投过票了
                <% elsif @poll.is_votable_by? current_user %>
                  <span class="button"><span><button type="submit" id='poll_vote_submit_btn'>投票</button></span></span>
                <% else %>
                  只有<%= get_subject @user %>的好友才能投票
                <% end %> 
              <% end %>
              </td>
            </tr>
          <% end %>
          </table>
        <% end %>
        <div class='vote-detail gray'>
          <h3 class='space'>投票选项说明：</h3>
          <% if @poll.past %>
            <p class='jl-cutline' id='poll_explanation'><%= @poll.explanation %></p>
          <% elsif @vote %>
            <p class='jl-cutline' id='poll_explanation'><%= @poll.explanation %></p>
          <% else %>
            <p class='jl-cutline'>投票后才能看</p>
          <% end %>
          <h3 class='space'>投票情况</h3>
					<ul class='jl-cutline'>
          <% if @vote %>
            <li class='now'><%= profile_link current_user %> 投给了 <%= @vote.answers.map{|a| "\"#{truncate a.description, :length => 20, :omission => '...'}\""}.join(',') %><span class='time'></span></li>
          <% end %>
          <% @vote_feeds.each do |v| %>
            <li class='now'><%= profile_link v.voter %> 投给了 <%= v.answers.map{|a| "\"#{truncate a.description, :length => 20, :omission => '...'}\""}.join(',') %><span class='time'></span></li>
          <% end %>
					</ul>
        </div>
        <div class="foot s_clear">
          <div class="prompt-list-box">
            <h5>随便看看</h5>
            <div class="list-box box04">
              <ul class="lister02">
                <% Poll.random(:limit => 5, :except => [@poll]).each do |p|%>
                <li><%= poll_link p %></li>
                <% end %>
              </ul>
            </div>
          </div>
          <div class="feed-list">
            <h4>评论(<%= @poll.comments_count %>)</h4>
            <%= render :partial => 'user/comments/comment_box', :locals => {:commentable => @poll, :recipient => @poll.poster} %> 
          </div>
        </div>
      </div>
    </div>
  </div></div>
</div></div></div></div>

<% unless @reply_to.blank? %>
<%= javascript_tag "Iyxzone.Comment.set('poll', #{@poll.id}, '#{@reply_to.login}', #{@reply_to.id});" %>
<% end %>
